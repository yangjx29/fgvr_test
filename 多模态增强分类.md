## 多模态增强分类（MEC）集成设计

本文档基于 `Multimodal_Enhanced_Classification` 目录与其 `README.md` 的算法说明，设计如何将该框架作为插件集成进当前快/慢思考系统，以提升分类性能，并定义在 `discovering.py` 中新增模式调用该目录下代码的统一策略与接口。

### 背景与目标
- MEC思想：用 CLIP 提取图像与文本特征，拼接为[图-文]多模态特征，针对多视图增强后的特征用熵计算权重，再做加权相似度匹配，完成“待测[图-文] vs 检索[图-文]”的直接匹配分类。
- 本系统目标：把 MEC 作为快/慢思考后的“增强器”，在不破坏原有流程的前提下，以低侵入方式调用 MEC 完成更强的相似度匹配或最终裁决，得到更稳健的 Top-1 预测与更可信的置信度。

---

## MEC 框架要点（来自目录与README）
- 特征抽取（pre_extract.py）：
  - 对检索集与测试集分别执行 n_views 多视图增强，使用 CLIP 编码图像与文本，拼接为多模态特征 `[Ti, Ii]`、`[T'j, I'j]`，并 L2 Norm。
  - 保存到 `pre_extracted_feat/{arch}/seed{seed}/{dataset}_{retrieved|test}.pth`。
- 相似度计算（evaluate.py）：
  - 分别对检索与测试多视图特征计算熵，softmax(-entropy/temperature) 得到权重，做加权平均得到单向量表示。
  - 对两端加权向量做余弦相似度（带 logit_scale），取最大值对应的标签作为预测。
- 输入要求：
  - 两组数据：`{dataset}_retrieved` 与 `{dataset}_test`，及其描述 JSON：`descriptions/{dataset}_retrieved_descriptions.json` 与 `{dataset}_test_descriptions.json`。

---

## 集成设计总览

为保持与现有流水线解耦并支持并行，MEC 作为“可选增强阶段”接入到三类节点：

- 快思考增强（Fast→MEC）：当 `need_slow_thinking=False` 时，MEC 对“查询图像+描述”与“候选库+描述”做一次更精细的匹配，用以确认或修正快思考预测。
- 慢思考增强（Slow→MEC）：当 `need_slow_thinking=True` 时，以快思考Top-K候选为检索库，用 MEC 进一步比较，得到一个更强的“检索匹配信号”，与慢思考的语言判别结果互证。
- 最终裁决增强（Final Decision→MEC）：当快慢不一致进入裁决时，MEC 的匹配分数作为关键证据之一，与已有 `_final_decision` 的证据池融合，提升裁决鲁棒性。

为保证性能与工程可用性，MEC 所需的描述与特征尽可能复用/缓存，避免重复生成。

---

## 数据对齐与输入构造

MEC需要两端输入：测试端（待分类图像+描述）与检索端（候选图像+描述）。在当前系统中来源如下：

- 测试端（Query/Test）：
  - 图像：来自 `infer` 结果中的 `query_image`。
  - 文本描述：优先级建议：
    1) 若慢思考已生成结构化描述/推理要点，可压缩为一句摘要作为测试描述；
    2) 否则使用 `CDVCaptioner` 生成的图像描述；
    3) 若有文本知识库（Text-KB）中缓存的描述，也可直接取用。

- 检索端（Retrieved）：
  - 图像集合：两种策略，按场景选择：
    - A) 全量知识库图片（更重，适合一次性评估）
    - B) 快思考 Top-K 候选所对应类别的代表图片（建议默认，轻量高效）
  - 文本描述：优先级建议：
    1) 知识库中缓存的类别描述/模板描述；
    2) 现有 `descriptions/xxx_retrieved_descriptions.json`；
    3) 若缺失则用 `CDVCaptioner` 批量生成并缓存。

说明：若采用策略B（Top-K检索库），每个 Query 的检索端内容不同，更适合“单样本/小批”评估；若采用策略A，可对全体测试样本一次性运行 MEC，但计算更重。

---

## 执行与缓存策略

为降低开销，集成采用“按需构造 + 强缓存”的思路：

1) 描述缓存
- 路径：`experiments/{dataset}/mec/descriptions/`
- 命名：
  - `test_descriptions.json`：测试端描述（query侧）
  - `retrieved_descriptions.json`：检索端描述（候选侧，若Top-K可为每次会话缓存一个子集版本）

2) 特征缓存（复用MEC目录结构）
- 路径：`Multimodal_Enhanced_Classification/pre_extracted_feat/{arch}/seed{seed}/`
- 命名： `{dataset}_test.pth`、`{dataset}_retrieved.pth` 或 `{dataset}_{session_hash}_retrieved.pth`（Top-K子集）

3) 临时数据集视图
- 当采用Top-K子集策略时，为与MEC `evaluate.py` 的全量接口对齐，可为每个会话生成一个“临时数据视图”（软链接或小清单）用于一次性评估：
  - `data/{dataset}_{session_hash}_retrieved/`（仅包含本次Top-K对应图片）
  - `data/{dataset}_{session_hash}_test/`（仅包含本次测试图片或小批）

---

## 与现有模式的对接方案

为保持职责清晰，建议新增三类“增强模式”，与现有并行模式一一对应：

### 1) mec_fast_classify（快思考增强）
- 前置：依赖 `fast_slow_infer` 的输出（含 `fast_result` 与 Top-K 候选）。
- 输入构造：
  - Test 端：`query_image` + 其描述（规则见前述优先级）。
  - Retrieved 端：快思考 `fused_results` 或 `img/text` Top-K 的代表图片集 + 描述。
- 执行：
  - 若对应缓存不存在，则调用 MEC 的 `pre_extract.py` 生成特征，再调用 `evaluate.py` 做匹配；
  - 若缓存存在，直接 `evaluate.py`。
- 输出：
  - 在 `experiments/{dataset}/classify/fast_classification_results_mec.json` 记录 MEC 重估的预测与分数；
  - 产生 `mec_fast_confidence` 等字段，供后续融合或对比。

### 2) mec_slow_classify（慢思考增强）
- 前置：依赖 `fast_slow_infer` 的输出（含 `need_slow_thinking=True` 的样本与其慢思考候选）。
- 输入构造与执行：与 `mec_fast_classify` 一致，但检索端仅取“需慢思考的样本”的Top-K候选集合。
- 输出：
  - 在 `experiments/{dataset}/classify/slow_classification_results_mec.json` 记录增强结果，并标注与慢思考预测的一致性情况（用于后续裁决）。

### 3) mec_terminal_decision（终端裁决增强）
- 触发：当快慢不一致进入裁决或 `terminal_decision` 阶段。
- 执行：
  - 对该批需要裁决的样本，基于其 Top-K 候选构造 MEC 输入并运行评估；
  - 将 MEC 的相似度/置信度作为裁决证据注入 `_final_decision` 融合函数；
  - 若 `_final_decision` 已支持多源证据加权，建议新增一条通道 `evidence.mec_similarity` 与权重 `alpha_mec`；默认轻量启用（如0.2~0.4）。
- 输出：
  - 在 `experiments/{dataset}/classify/terminal_decision_results.json` 合并最终结果，并追加 `mec_support` 字段（包含Top-1候选、相似度、是否改变最终预测等）。

---

## 运行与参数建议

### 关键参数
- `mec_top_k`：检索端候选数（建议与快思考Top-K一致，如5或10）。
- `mec_arch`：CLIP架构（与MEC一致，默认与知识库/检索所用模型同源）。
- `mec_n_views`：多视图数（默认 32~50，按资源权衡）。
- `mec_temperature`：权重softmax温度（默认0.5）。
- `mec_logit_scale`：相似度缩放（沿用CLIP学习到的logit_scale，或配置项）。
- `mec_cache`：是否启用缓存与缓存目录。

### 典型流程
```bash
# 1) 先生成基础推理结果
python discovering.py --mode=fast_slow_infer --infer_dir=./experiments/pet37/infer --knowledge_base_dir=./experiments/pet37/knowledge_base

# 2) 并行增强快/慢思考
python discovering.py --mode=mec_fast_classify  --infer_dir=./experiments/pet37/infer --classify_dir=./experiments/pet37/classify &
python discovering.py --mode=mec_slow_classify  --infer_dir=./experiments/pet37/infer --classify_dir=./experiments/pet37/classify &
wait

# 3) 终端裁决融合（使用MEC证据）
python discovering.py --mode=mec_terminal_decision --infer_dir=./experiments/pet37/infer --classify_dir=./experiments/pet37/classify
```

---

## 与现有结果的对齐与记录

为便于对比与回溯，新增结果文件命名建议：
- `fast_classification_results_mec.json`
- `slow_classification_results_mec.json`
- `terminal_decision_results_mec.json`

每条样本结果建议包含：
- `query_image`、`true_category`
- `mec_prediction`、`mec_confidence`
- `mec_topk_support`（可选，包含若干候选与相似度）
- `used_in_final_decision`（bool）
- `final_prediction`、`final_confidence`、`decision_path`

---

## 失败与回退策略
- 若描述缺失或生成失败：回退到已有 caption 或最简模板描述（如“a photo of a {category}”）。
- 若特征缓存损坏：自动重跑 `pre_extract.py` 对应分片。
- 若MEC评估失败：保持原有快/慢思考结果，不中断主流程；记录 `mec_error` 字段。

---

## 评测与消融建议
- 对比以下配置以量化收益：
  1) baseline（无MEC）
  2) Fast→MEC（仅快思考增强）
  3) Slow→MEC（仅慢思考增强）
  4) Final Decision→MEC（仅终端裁决增强）
  5) 全量（Fast+Slow+Final with MEC）
- 关键指标：总体准确率、快思考准确率、慢思考触发比例与准确率、裁决改判率/改判增益。

---

## 已实现的增强模式

在 `discovering.py` 中已成功实现以下三个多模态增强模式：

### 1. fast_classify_enhanced模式
```bash
python discovering.py --mode=fast_classify_enhanced --infer_dir=./experiments/pet37/infer --classify_dir=./experiments/pet37/classify
```

**实现特点**:
- 通过 `subprocess` 调用MEC的 `pre_extract.py` 和 `evaluate.py`
- 自动构造测试端和检索端数据
- 使用快思考Top-K候选作为检索库
- 输出: `fast_classification_results_enhanced.json`
- 包含原始准确率vs增强准确率对比

**数据构造**:
- 测试端描述: 基于快思考预测结果 `f"a photo of a {fast_pred}"`  
- 检索端: 快思考fused_results Top-5候选的代表图像
- 检索端描述: 从知识库text_kb获取类别描述

### 2. slow_classify_enhanced模式
```bash
python discovering.py --mode=slow_classify_enhanced --infer_dir=./experiments/pet37/infer --classify_dir=./experiments/pet37/classify
```

**实现特点**:
- 仅处理 `need_slow_thinking=True` 的样本
- 使用完整的慢思考推理文本作为描述（不进行摘要）
- 检索端使用慢思考的enhanced_results候选
- 输出: `slow_classification_results_enhanced.json`
- 标记快慢一致性，识别需要终端决策的样本

**数据构造**:
- 测试端描述: 慢思考完整推理文本 `slow_reasoning`
- 检索端: 慢思考enhanced_results Top-5候选
- 检索端描述: 从知识库text_kb获取详细类别描述

### 3. terminal_decision_enhanced模式
```bash
python discovering.py --mode=terminal_decision_enhanced --infer_dir=./experiments/pet37/infer --classify_dir=./experiments/pet37/classify
```

**实现特点**:
- 依赖前两个模式的输出文件
- 对快慢不一致的样本执行增强融合决策
- 简单置信度加权融合策略
- 输出: `terminal_decision_results_enhanced.json`
- 完整的增强效果统计

**融合策略**:
- 比较增强后的快慢思考置信度
- 选择置信度更高的预测作为最终结果
- 记录决策来源（enhanced_slow/enhanced_fast）

## 实现状态与接口说明

### 核心接口
- **MEC流水线**: 通过 `utils/mec_helper.py` 的 `run_mec_pipeline()` 函数统一调用
- **数据构造**: 使用 `create_mec_data_structure()` 创建标准的MEC数据结构
- **批量处理**: 先收集所有样本，再批量调用MEC，提高效率
- **结果解析**: 通过 `parse_mec_output()` 解析MEC输出的准确率和统计信息
- **清理机制**: 使用 `cleanup_mec_temp_files()` 自动清理临时文件
- **知识库接口**: 加载image_kb.json和text_kb.json构造检索数据
- **结果接口**: 统一的JSON结果格式，包含增强统计信息

### 错误处理与回退
- **自动回退**: MEC调用失败时回退到原始分类逻辑  
- **错误记录**: 在结果中记录 `enhanced` 标记和错误信息
- **稳定性保证**: 确保增强失败不影响主流程运行

### 文件组织
```
experiments/{dataset}/classify/
├── fast_classification_results_enhanced.json
├── slow_classification_results_enhanced.json  
└── terminal_decision_results_enhanced.json
```

### 统计指标
- `original_accuracy`: 原始方法准确率
- `enhanced_accuracy`: 增强后准确率
- `enhancement_rate`: 增强提升率
- 完整的快慢思考触发统计

---

## 小结
本设计将 MEC 作为“可插拔的相似度增强器”无缝接入快/慢思考流程：
- 用更强的[图-文]对[图-文]匹配补强快思考确认、慢思考互证与最终裁决，整体提升精度与稳定性；
- 采用按需构造与强缓存，兼顾性能与易用性；
- 通过新增并行增强模式，保持与现有流水线的调用一致性与结果可对齐性。


