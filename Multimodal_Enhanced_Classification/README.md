# Multimodal Enhanced Classification: å¤šæ¨¡æ€å¢å¼ºåˆ†ç±»æ¡†æ¶

æœ¬æ–‡é¢å‘ `Multimodal_Enhanced_Classification` ç›®å½•ï¼Œç³»ç»Ÿæ€§æ¦‚æ‹¬å¤šæ¨¡æ€å¢å¼ºåˆ†ç±»æ¡†æ¶çš„æ¨ç†æµç¨‹ä¸ç®—æ³•å®ç°ï¼Œä¾¿äºå¿«é€Ÿç†è§£ä¸å¤ç°ã€‚

## èƒŒæ™¯ä¸ç›®æ ‡

**æ ¸å¿ƒæ€æƒ³**ï¼šå®ç°**å¾…æµ‹è¯•[å›¾-æ–‡]ä¸æ£€ç´¢åˆ°çš„kå¼ [å›¾-æ–‡]è¿›è¡ŒåŒ¹é…**çš„åˆ†ç±»ç­–ç•¥ã€‚

è¯¥æ¡†æ¶ä½¿ç”¨CLIPæå–å›¾åƒå’Œæ–‡æœ¬çš„å¤šæ¨¡æ€ç‰¹å¾ï¼Œé€šè¿‡ç‰¹å¾æ‹¼æ¥ã€åŸºäºç†µçš„æƒé‡è®¡ç®—å’ŒåŠ æƒç›¸ä¼¼åº¦åŒ¹é…æ¥å®ç°ç²¾å‡†çš„ç»†ç²’åº¦è§†è§‰è¯†åˆ«ã€‚ä¸ä¼ ç»Ÿçš„å•å›¾åƒåŒ¹é…ä¸åŒï¼Œæœ¬æ–¹æ³•åŒæ—¶å¤„ç†æ¯ä¸ªç±»åˆ«çš„kå¼ å›¾åƒï¼Œè®¡ç®—kä¸ªåŠ æƒç›¸ä¼¼åº¦å¹¶å–å¹³å‡ï¼Œæé«˜åˆ†ç±»çš„ç¨³å®šæ€§å’Œå‡†ç¡®æ€§ã€‚

### æ ¸å¿ƒæ”¹è¿›ï¼ˆåŸºäºAWTæ€æƒ³ + kå›¾åƒå¢å¼ºï¼‰
- **A: Augmentation** å¯¹æµ‹è¯•å›¾åƒå’Œæ¯ä¸ªç±»åˆ«çš„kå¼ æ£€ç´¢å›¾åƒåˆ†åˆ«è¿›è¡Œå¤šè§†å›¾å¢å¼ºï¼Œæå‡ç¨³å¥æ€§ï¼›
- **W: Weighting** ä»¥ä¸ç¡®å®šæ€§ï¼ˆç†µï¼‰è‡ªé€‚åº”ä¼°è®¡æ¯å¼ å›¾åƒçš„å¤šæ¨¡æ€ç‰¹å¾æƒé‡ï¼›
- **T: Transportation** è®¡ç®—æµ‹è¯•å›¾åƒä¸æ¯ä¸ªç±»åˆ«kå¼ å›¾åƒçš„åŠ æƒç›¸ä¼¼åº¦ï¼Œå–å¹³å‡åå®ç°å¤šæ¨¡æ€åŒ¹é…ã€‚

### ğŸ†• AWCç»†åˆ†é€»è¾‘ä¼˜åŒ–ï¼ˆé…ç½®é©±åŠ¨ï¼‰

ä¸ºäº†å……åˆ†åˆ©ç”¨AWCå¢å¼ºä¿¡æ¯ï¼Œæ¡†æ¶æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶çµæ´»é€‰æ‹©ä¸åŒçš„å¤„ç†ç­–ç•¥ï¼š

#### é…ç½®æ–‡ä»¶ï¼š`config.yaml`
```yaml
# K-shotå›¾åƒå¤„ç†ç­–ç•¥
k_shot_image_processing: "weighted_separate"  # average | simultaneously_enhance

# ç›¸ä¼¼åº¦è®¡ç®—ç­–ç•¥  
similarity_processing: "weighted_separate"  # image_text_pair | weighted_separate

# è¶…å‚æ•°é…ç½®
similarity_processing_hyper_parameter:
  weighted_separate:
    weights: [0.4, 0.4, 0.1, 0.1]  # [æ–‡-æ–‡ï¼Œå›¾-å›¾ï¼Œå›¾-æ–‡ï¼Œæ–‡-å›¾]
```

#### ç­–ç•¥è¯´æ˜

**K-shotå¤„ç†ç­–ç•¥**ï¼š
- `average`ï¼šå¤šå›¾åƒåŠ æƒç›¸ä¼¼åº¦ç›´æ¥å–å¹³å‡ï¼ˆåŸæœ‰ç­–ç•¥ï¼‰
- `simultaneously_enhance`ï¼škå¼ å›¾åƒçš„æ‰€æœ‰å­è§†å›¾åŒæ—¶ä½œä¸ºå¢å¼ºè§†å›¾ï¼ˆæ–°å¢ï¼‰

**ç›¸ä¼¼åº¦è®¡ç®—ç­–ç•¥**ï¼š
- `image_text_pair`ï¼šå›¾æ–‡å¯¹æ‹¼æ¥åè®¡ç®—æ•´ä½“ç›¸ä¼¼åº¦ï¼ˆåŸæœ‰ç­–ç•¥ï¼‰
- `weighted_separate`ï¼šåˆ†åˆ«è®¡ç®—æ–‡-æ–‡ã€å›¾-å›¾ã€å›¾-æ–‡ã€æ–‡-å›¾å››ç§ç›¸ä¼¼åº¦å¹¶åŠ æƒèåˆï¼ˆæ–°å¢ï¼‰

**ç­–ç•¥ç»„åˆå»ºè®®**ï¼š
1. **ä¿å®ˆç»„åˆ**ï¼š`average + image_text_pair` - ç¨³å®šå¯é 
2. **ç²¾ç»†ç»„åˆ**ï¼š`average + weighted_separate` - æå‡ç›¸ä¼¼åº¦è®¡ç®—ç²¾åº¦
3. **å¢å¼ºç»„åˆ**ï¼š`simultaneously_enhance + image_text_pair` - æå‡k-shotåˆ©ç”¨æ•ˆç‡
4. **æ¿€è¿›ç»„åˆ**ï¼š`simultaneously_enhance + weighted_separate` - æœ€å¤§åŒ–ä¿¡æ¯åˆ©ç”¨

---

## æ•°æ®ä¸ä½¿ç”¨æ–¹å¼æ¦‚è§ˆ

### æ•°æ®è¦æ±‚
- ä¸¤ç»„å›¾åƒæ•°æ®é›†ï¼š
  - `{dataset}_retrieved`ï¼šæ£€ç´¢åˆ°çš„å›¾åƒï¼ˆæ¯ä¸ªç±»åˆ«åŒ…å«kå¼ å›¾åƒä½œä¸ºå‚è€ƒåº“ï¼‰
  - `{dataset}_test`ï¼šå¾…æµ‹è¯•çš„å›¾åƒï¼ˆéœ€è¦åˆ†ç±»çš„å›¾åƒï¼‰
- å¯¹åº”çš„æ–‡æœ¬æè¿°æ–‡ä»¶ï¼š
  - `./descriptions/{dataset}_retrieved_descriptions.json`ï¼šæ£€ç´¢å›¾åƒçš„æè¿°ï¼ˆæ”¯æŒå¤šå›¾åƒæè¿°ï¼‰
  - `./descriptions/{dataset}_test_descriptions.json`ï¼šæµ‹è¯•å›¾åƒçš„æè¿°
- ç±»åˆ«å›¾åƒè·¯å¾„æ–‡ä»¶ï¼š
  - `./experiments/{dataset}/knowledge_base/category_image_paths.json`ï¼šå­˜å‚¨æ¯ä¸ªç±»åˆ«çš„kå¼ å›¾åƒè·¯å¾„

### ä½¿ç”¨æµç¨‹
```bash
# 1. é¢„æå–å¤šæ¨¡æ€ç‰¹å¾ï¼ˆåŒæ—¶å¤„ç†æ£€ç´¢å’Œæµ‹è¯•å›¾åƒï¼‰
python pre_extract.py [data_path] --test_set [dataset_name]

# 2. è¿è¡Œå¤šæ¨¡æ€å¢å¼ºåˆ†ç±»è¯„ä¼°
python evaluate.py --test_set [dataset_name]
```

---

## æµæ°´çº¿ç»†èŠ‚ï¼ˆä¸å®ç°æ–‡ä»¶å¯¹åº”ï¼‰

### 1) é¢„æå–å¤šæ¨¡æ€ç‰¹å¾ï¼ˆpre_extract.pyï¼‰

- ä½¿ç”¨ CLIP å¯¹æµ‹è¯•å›¾åƒå’Œæ¯ä¸ªç±»åˆ«çš„kå¼ æ£€ç´¢å›¾åƒåˆ†åˆ«ç”Ÿæˆ **n_views** ä¸ªå¢å¼ºè§†å›¾ç‰¹å¾ï¼Œå¹¶ç»“åˆå¯¹åº”çš„æ–‡æœ¬æè¿°ï¼š
  - åŸºç¡€å˜æ¢ï¼šResizeâ†’CenterCropï¼›
  - å½’ä¸€åŒ–ï¼šä¸ CLIP é¢„å¤„ç†ä¸€è‡´ï¼›
  - å¢å¼ºå™¨ `Augmenter(base_transform, preprocess, n_views)` äº§å‡ºå¤šè§†å›¾ï¼›
  - å¯¹æ¯å¼ å›¾åƒç¼–ç å…¶å¯¹åº”çš„æ–‡æœ¬æè¿°ï¼›
  - å°†æ–‡æœ¬ç‰¹å¾å’Œå›¾åƒç‰¹å¾æ‹¼æ¥ï¼š`[Ti, Ii]`ï¼ˆæ£€ç´¢ï¼‰å’Œ `[T'j, I'j]`ï¼ˆæµ‹è¯•ï¼‰ï¼›
  - **kå›¾åƒå¤„ç†**ï¼šæ¯ä¸ªç±»åˆ«çš„kå¼ å›¾åƒæ‹¼æ¥æˆå¤§çš„ç‰¹å¾å¼ é‡ `(k*n_views, 2*d)`ï¼›
  - ç¼–ç åå¯¹æ¯ä¸ªå‘é‡åš L2 å½’ä¸€åŒ–ï¼›
  - åˆ†åˆ«ä¿å­˜åˆ° `./pre_extracted_feat/{arch}/seed{seed}/{dataset}_retrieved.pth` å’Œ `{dataset}_test.pth`ã€‚

å½¢çŠ¶çº¦å®šï¼š
- å•æ ·æœ¬å¤šæ¨¡æ€ç‰¹å¾ `multimodal_features âˆˆ R^{n_views Ã— 2d}`ï¼Œå·² L2-Normã€‚

### 2) å¤šæ¨¡æ€å¢å¼ºåˆ†ç±»è¯„ä¼°ï¼ˆevaluate.pyï¼‰

- åŠ è½½ä¸¤ç»„é¢„æå–çš„å¤šæ¨¡æ€ç‰¹å¾ï¼š
  - `retrieved_data`: æ£€ç´¢å›¾åƒçš„[å›¾-æ–‡]ç‰¹å¾ `[(multimodal_features, target), ...]`ï¼ˆæ”¯æŒkå¼ å›¾åƒï¼‰
  - `test_data`: å¾…æµ‹è¯•å›¾åƒçš„[å›¾-æ–‡]ç‰¹å¾ `[(multimodal_features, target), ...]`
- å¯¹æ¯ä¸ªå¾…æµ‹è¯•æ ·æœ¬ï¼Œè®¡ç®—ä¸æ‰€æœ‰æ£€ç´¢æ ·æœ¬çš„å¤šæ¨¡æ€ç›¸ä¼¼åº¦ï¼š
  - **kå›¾åƒå¤„ç†**ï¼šå¯¹æ¯ä¸ªç±»åˆ«çš„kå¼ å›¾åƒåˆ†åˆ«è®¡ç®—åŠ æƒç›¸ä¼¼åº¦
  - **å¹³å‡èšåˆ**ï¼šå°†kä¸ªç›¸ä¼¼åº¦å–å¹³å‡ä½œä¸ºæœ€ç»ˆç±»åˆ«ç›¸ä¼¼åº¦

### 3) æƒé‡è®¡ç®—ä¸å¤šæ¨¡æ€ç›¸ä¼¼åº¦åŒ¹é…

- ä½¿ç”¨åŸºäºç†µçš„æƒé‡è®¡ç®—ï¼ˆæ”¯æŒkå›¾åƒï¼‰ï¼š
  - å¯¹æµ‹è¯•å›¾åƒçš„å¤šè§†å›¾ç‰¹å¾è®¡ç®—ç†µï¼š`test_entropy = calculate_batch_entropy(test_features)`
  - å¯¹æ¯å¼ æ£€ç´¢å›¾åƒçš„å¤šè§†å›¾ç‰¹å¾åˆ†åˆ«è®¡ç®—ç†µï¼š`retrieved_entropy = calculate_batch_entropy(single_image_features)`
  - æƒé‡è®¡ç®—ï¼š`weights = F.softmax(-entropy / temperature, dim=0)`
  - åŠ æƒå¹³å‡ï¼š`weighted_features = (features * weights.unsqueeze(-1)).sum(dim=0)`
- è®¡ç®—kä¸ªåŠ æƒç›¸ä¼¼åº¦å¹¶å–å¹³å‡ï¼š
  - L2å½’ä¸€åŒ–ï¼š`weighted_features = weighted_features / weighted_features.norm()`
  - ä½™å¼¦ç›¸ä¼¼åº¦ï¼š`similarity_k = torch.dot(weighted_test, weighted_retrieved_k)`
  - å¹³å‡èšåˆï¼š`avg_similarity = torch.stack(similarities).mean()`

---

## Weightingï¼šå¤šæ¨¡æ€ç‰¹å¾æƒé‡ä¼°è®¡

åœ¨å¤šæ¨¡æ€å¢å¼ºåˆ†ç±»ä¸­ï¼Œæˆ‘ä»¬å¯¹ä¸¤ç»„å¤šæ¨¡æ€ç‰¹å¾åˆ†åˆ«è®¡ç®—æƒé‡ï¼Œç†µå®šä¹‰ä¸º \( H(p) = -\sum_i p_i \log p_i \)ã€‚

### å¤šæ¨¡æ€ç‰¹å¾æƒé‡è®¡ç®—

- **å¾…æµ‹è¯•æ ·æœ¬æƒé‡**ï¼š
  - è®¡ç®—æ¯ä¸ªè§†å›¾çš„ç†µï¼š`entropy = calculate_batch_entropy(test_features)`
  - `test_weights = F.softmax(-entropy / temperature, dim=0)`ï¼Œç†µè¶Šä½æƒé‡è¶Šå¤§ã€‚

- **æ£€ç´¢æ ·æœ¬æƒé‡**ï¼š
  - è®¡ç®—æ¯ä¸ªè§†å›¾çš„ç†µï¼š`entropy = calculate_batch_entropy(retrieved_features)`
  - `retrieved_weights = F.softmax(-entropy / temperature, dim=0)`ï¼Œç†µè¶Šä½æƒé‡è¶Šå¤§ã€‚

- **åŠ æƒå¹³å‡**ï¼š
  - `weighted_test = (test_features * test_weights.unsqueeze(-1)).sum(dim=0)`
  - `weighted_retrieved = (retrieved_features * retrieved_weights.unsqueeze(-1)).sum(dim=0)`

è¶…å‚ï¼š`temperature âˆˆ (0, +âˆ)` æ§åˆ¶ softmax å¹³æ»‘åº¦ï¼Œé»˜è®¤ä¸º 0.5ã€‚

---

## Transportationï¼šåŠ æƒå¤šæ¨¡æ€ç›¸ä¼¼åº¦è®¡ç®—

åœ¨å¤šæ¨¡æ€å¢å¼ºåˆ†ç±»ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨åŠ æƒç›¸ä¼¼åº¦è®¡ç®—æ¥å®ç°[å›¾-æ–‡]ç‰¹å¾åŒ¹é…ã€‚

### åŠ æƒå¤šæ¨¡æ€ç›¸ä¼¼åº¦åŒ¹é…æµç¨‹

1. **å¤šæ¨¡æ€ç‰¹å¾åŠ æƒ**ï¼š
   - å¯¹ä¸¤ç»„å¤šæ¨¡æ€ç‰¹å¾åˆ†åˆ«è®¡ç®—æƒé‡å¹¶åŠ æƒå¹³å‡
   - `weighted_test = (test_features * test_weights.unsqueeze(-1)).sum(dim=0)`
   - `weighted_retrieved = (retrieved_features * retrieved_weights.unsqueeze(-1)).sum(dim=0)`

2. **L2å½’ä¸€åŒ–**ï¼š
   - `weighted_test = weighted_test / weighted_test.norm()`
   - `weighted_retrieved = weighted_retrieved / weighted_retrieved.norm()`

3. **å¤šæ¨¡æ€ç›¸ä¼¼åº¦è®¡ç®—**ï¼š
   - `similarity = logit_scale.exp() * torch.dot(weighted_test, weighted_retrieved)`

4. **åŒ¹é…å†³ç­–**ï¼š
   - æ‰¾åˆ°ç›¸ä¼¼åº¦æœ€é«˜çš„æ£€ç´¢æ ·æœ¬ï¼š`max_idx = torch.argmax(similarities)`
   - ä½¿ç”¨è¯¥æ ·æœ¬çš„æ ‡ç­¾ä½œä¸ºé¢„æµ‹ï¼š`predicted_label = retrieved_labels[max_idx]`

---

## å¤šæ¨¡æ€å¢å¼ºåˆ†ç±»ç®—æ³•ç‰¹ç‚¹

### æ ¸å¿ƒæ”¹è¿›

1. **[å›¾-æ–‡]å¯¹[å›¾-æ–‡]åŒ¹é…**ï¼š
   - å®ç°å¾…æµ‹è¯•å›¾åƒæ–‡æœ¬å¯¹ä¸æ£€ç´¢å›¾åƒæ–‡æœ¬å¯¹çš„ç›´æ¥åŒ¹é…
   - æ¯ä¸ªæ ·æœ¬éƒ½åŒ…å«å›¾åƒå’Œå¯¹åº”çš„æ–‡æœ¬æè¿°ä¿¡æ¯

2. **å¤šæ¨¡æ€ç‰¹å¾èåˆ**ï¼š
   - å°†å›¾åƒç‰¹å¾å’Œå¯¹åº”æ–‡æœ¬æè¿°ç‰¹å¾æ‹¼æ¥ï¼š`[Ti, Ii]` å’Œ `[T'j, I'j]`
   - ç‰¹å¾ç»´åº¦ä» `d` æ‰©å±•åˆ° `2d`ï¼ŒåŒ…å«æ›´ä¸°å¯Œçš„è¯­ä¹‰ä¿¡æ¯

3. **åŒå‘æƒé‡è®¡ç®—**ï¼š
   - å¯¹ä¸¤ç»„å¤šæ¨¡æ€ç‰¹å¾åˆ†åˆ«è®¡ç®—åŸºäºç†µçš„æƒé‡
   - æƒé‡åæ˜ æ¯ä¸ªè§†å›¾çš„ä¸ç¡®å®šæ€§ï¼Œç†µè¶Šä½æƒé‡è¶Šé«˜

4. **ç«¯åˆ°ç«¯åŒ¹é…**ï¼š
   - ç›´æ¥åœ¨å¤šæ¨¡æ€ç‰¹å¾ç©ºé—´è¿›è¡Œç›¸ä¼¼åº¦è®¡ç®—
   - æ— éœ€é¢„å®šä¹‰ç±»åˆ«æ¨¡æ¿ï¼Œæ›´åŠ çµæ´»

5. **æ£€ç´¢å¢å¼ºåˆ†ç±»**ï¼š
   - åˆ©ç”¨æ£€ç´¢åˆ°çš„ç›¸å…³æ ·æœ¬è¿›è¡Œåˆ†ç±»å†³ç­–
   - æé«˜åˆ†ç±»å‡†ç¡®æ€§å’Œé²æ£’æ€§

---

## å…³é”®è¶…å‚ä¸å½¢çŠ¶é€ŸæŸ¥

### å¤šæ¨¡æ€ç‰¹å¾å½¢çŠ¶
- `image_features`: `(n_views, d)` - å¤šè§†å›¾å›¾åƒç‰¹å¾
- `text_features`: `(1, d)` - å•ä¸ªæ–‡æœ¬æè¿°ç‰¹å¾
- `multimodal_features`: `(n_views, 2*d)` - æ‹¼æ¥åçš„[å›¾-æ–‡]ç‰¹å¾
- `test_weights`: `(n_views,)` - å¾…æµ‹è¯•æ ·æœ¬çš„è§†å›¾æƒé‡
- `retrieved_weights`: `(n_views,)` - æ£€ç´¢æ ·æœ¬çš„è§†å›¾æƒé‡
- `weighted_test`: `(2*d,)` - åŠ æƒåçš„å¾…æµ‹è¯•[å›¾-æ–‡]ç‰¹å¾
- `weighted_retrieved`: `(2*d,)` - åŠ æƒåçš„æ£€ç´¢[å›¾-æ–‡]ç‰¹å¾

### å…³é”®è¶…å‚æ•°
- `n_views`ï¼šæ¯å›¾åƒçš„å¢å¼ºè§†å›¾æ•°é‡ï¼ˆé»˜è®¤ 50ï¼‰
- `temperature`ï¼šæƒé‡ softmax æ¸©åº¦ï¼ˆé»˜è®¤ 0.5ï¼‰
- `resolution`ï¼šè¾“å…¥åˆ†è¾¨ç‡ï¼ˆé»˜è®¤ 224ï¼‰

---

## å¤ç°å®ç”¨æé†’

1. **æ•°æ®å‡†å¤‡**ï¼šç¡®ä¿æ£€ç´¢å›¾åƒé›†ã€æµ‹è¯•å›¾åƒé›†å’Œå¯¹åº”çš„æè¿°JSONæ–‡ä»¶å‡†å¤‡å®Œæ•´
2. **ç‰¹å¾æå–**ï¼šå…ˆè¿è¡Œ `pre_extract.py` æå–å¹¶ä¿å­˜å¤šæ¨¡æ€[å›¾-æ–‡]ç‰¹å¾
3. **åˆ†ç±»è¯„ä¼°**ï¼šå†è¿è¡Œ `evaluate.py` è¿›è¡Œå¤šæ¨¡æ€å¢å¼ºåˆ†ç±»è¯„ä¼°
4. **å‚æ•°è°ƒæ•´**ï¼šå¯ä»¥è°ƒæ•´æ¸©åº¦å‚æ•°ï¼ˆé»˜è®¤0.5ï¼‰æ¥æ§åˆ¶æƒé‡åˆ†å¸ƒçš„å¹³æ»‘åº¦
5. **GPUå†…å­˜**ï¼šæ³¨æ„å¤šè§†å›¾å¤šæ¨¡æ€ç‰¹å¾å¯èƒ½å ç”¨è¾ƒå¤šGPUå†…å­˜ï¼Œå¯é€‚å½“è°ƒæ•´batch_size
6. **æè¿°è´¨é‡**ï¼šæ–‡æœ¬æè¿°çš„è´¨é‡ç›´æ¥å½±å“å¤šæ¨¡æ€ç‰¹å¾çš„è¡¨è¾¾èƒ½åŠ›å’Œæœ€ç»ˆåˆ†ç±»æ•ˆæœ

### æ•°æ®æ–‡ä»¶ç»“æ„
```
descriptions/
â”œâ”€â”€ {dataset_name}_retrieved_descriptions.json  # æ£€ç´¢å›¾åƒçš„æ–‡æœ¬æè¿°
â””â”€â”€ {dataset_name}_test_descriptions.json       # æµ‹è¯•å›¾åƒçš„æ–‡æœ¬æè¿°

data/
â”œâ”€â”€ {dataset_name}_retrieved/                   # æ£€ç´¢å›¾åƒæ•°æ®é›†
â””â”€â”€ {dataset_name}_test/                        # æµ‹è¯•å›¾åƒæ•°æ®é›†
```

---

## é›†æˆåˆ°å¿«æ…¢æ€è€ƒç³»ç»Ÿ

æœ¬MECæ¡†æ¶å·²è¢«é›†æˆåˆ°å¿«æ…¢æ€è€ƒç³»ç»Ÿä¸­ï¼Œæä¾›ä»¥ä¸‹å¢å¼ºæ¨¡å¼ï¼š

### å¢å¼ºæ¨¡å¼
- **fast_classify_enhanced**: å¿«æ€è€ƒä¸MECç»“åˆï¼Œå¯¹ä¸éœ€è¦æ…¢æ€è€ƒçš„æ ·æœ¬è¿›è¡Œå¤šæ¨¡æ€å¢å¼ºåˆ†ç±»
- **slow_classify_enhanced**: æ…¢æ€è€ƒä¸MECç»“åˆï¼Œä½¿ç”¨å®Œæ•´æ¨ç†æ–‡æœ¬è¿›è¡Œå¢å¼ºåˆ†ç±»
- **terminal_decision_enhanced**: ç»ˆç«¯å†³ç­–å¢å¼ºï¼Œæ•´åˆå¢å¼ºåçš„å¿«æ…¢æ€è€ƒç»“æœ

### è°ƒç”¨æ–¹å¼
```bash
# å¿«æ€è€ƒå¢å¼º
python discovering.py --mode=fast_classify_enhanced --infer_dir=./experiments/pet37/infer --classify_dir=./experiments/pet37/classify

# æ…¢æ€è€ƒå¢å¼º  
python discovering.py --mode=slow_classify_enhanced --infer_dir=./experiments/pet37/infer --classify_dir=./experiments/pet37/classify

# ç»ˆç«¯å†³ç­–å¢å¼º
python discovering.py --mode=terminal_decision_enhanced --infer_dir=./experiments/pet37/infer --classify_dir=./experiments/pet37/classify
```

### è¾“å‡ºæ–‡ä»¶
- `fast_classification_results_enhanced.json`: å¢å¼ºå¿«æ€è€ƒåˆ†ç±»ç»“æœ
- `slow_classification_results_enhanced.json`: å¢å¼ºæ…¢æ€è€ƒåˆ†ç±»ç»“æœ  
- `terminal_decision_results_enhanced.json`: ç»ˆç«¯å†³ç­–å¢å¼ºç»“æœ

### æ•°æ®æµç¨‹
```
æ¨ç†ç»“æœ â†’ æ„é€ MECè¾“å…¥ â†’ ç‰¹å¾æå– â†’ å¤šæ¨¡æ€åŒ¹é… â†’ å¢å¼ºåˆ†ç±»ç»“æœ
```

MECæ¡†æ¶é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¸å¿«æ…¢æ€è€ƒç³»ç»Ÿé›†æˆï¼š
1. **æ•°æ®å¯¹é½**: è‡ªåŠ¨ä»æ¨ç†ç»“æœæ„é€ æµ‹è¯•ç«¯å’Œæ£€ç´¢ç«¯æ•°æ®
2. **æè¿°ç”Ÿæˆ**: ä½¿ç”¨å¿«/æ…¢æ€è€ƒç»“æœå’ŒçŸ¥è¯†åº“æ„é€ æ–‡æœ¬æè¿°
3. **ç‰¹å¾ç¼“å­˜**: å¤ç”¨MECçš„ç‰¹å¾æå–å’Œç¼“å­˜æœºåˆ¶
4. **ç»“æœèåˆ**: å°†MECç›¸ä¼¼åº¦åŒ¹é…ç»“æœä¸åŸå§‹é¢„æµ‹è¿›è¡Œèåˆ
5. **æ‰¹é‡å¤„ç†**: å…ˆæ”¶é›†æ ·æœ¬å†æ‰¹é‡è°ƒç”¨MECï¼Œæé«˜å¤„ç†æ•ˆç‡
6. **é”™è¯¯æ¢å¤**: MECå¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°åŸå§‹åˆ†ç±»æ–¹æ³•
7. **è‡ªåŠ¨æ¸…ç†**: å®Œæˆåè‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç¼“å­˜

### è¾…åŠ©å‡½æ•°ï¼ˆutils/mec_helper.pyï¼‰
- `run_mec_pipeline()`: è¿è¡Œå®Œæ•´çš„MECæµæ°´çº¿
- `parse_mec_output()`: è§£æMECè¾“å‡ºç»“æœ
- `create_mec_data_structure()`: åˆ›å»ºMECæ ‡å‡†æ•°æ®ç»“æ„  
- `cleanup_mec_temp_files()`: æ¸…ç†ä¸´æ—¶æ–‡ä»¶

### æŠ€æœ¯æ”¹è¿›
- **åŠ¨æ€æ•°æ®é›†æ”¯æŒ**: ä¿®æ”¹äº† `data/datautils.py` æ”¯æŒä»»æ„ç›®å½•ç»“æ„
- **é”™è¯¯æ£€æŸ¥å¢å¼º**: åœ¨ `evaluate.py` å’Œ `pre_extract.py` ä¸­æ·»åŠ æ–‡ä»¶å­˜åœ¨æ£€æŸ¥
- **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰å¢å¼ºæ¨¡å¼ä½¿ç”¨ç›¸åŒçš„MECè°ƒç”¨æ¥å£

---

## å¼•ç”¨

è‹¥æœ¬å®ç°æˆ–æ–‡æ¡£å¯¹æ‚¨çš„ç ”ç©¶æœ‰å¸®åŠ©ï¼Œæ¬¢è¿å¼•ç”¨è®ºæ–‡ï¼š

Zhu, Yuhan; Ji, Yuyang; Zhao, Zhiyu; Wu, Gangshan; Wang, Limin. AWT: Transferring Vision-Language Models via Augmentation, Weighting, and Transportation. NeurIPS 2024.