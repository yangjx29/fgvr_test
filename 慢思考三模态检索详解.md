# æ…¢æ€è€ƒä¸‰æ¨¡æ€æ£€ç´¢è¯¦è§£

## æ¦‚è¿°

æ…¢æ€è€ƒç¡®å®é‡‡ç”¨äº†**ä¸‰æ¨¡æ€æ£€ç´¢**æœºåˆ¶ï¼Œè¿™æ˜¯åŒºåˆ«äºå¿«æ€è€ƒï¼ˆåŒæ¨¡æ€ï¼‰çš„é‡è¦ç‰¹å¾ã€‚ä¸‰ä¸ªæ¨¡æ€åˆ†åˆ«åˆ©ç”¨ä¸åŒçš„ä¿¡æ¯æºè¿›è¡Œæ£€ç´¢ï¼Œç„¶åé€šè¿‡åŠ æƒèåˆå¾—åˆ°æœ€ç»ˆç»“æœã€‚

## ä¸‰ä¸ªæ¨¡æ€æ£€ç´¢è¯¦è§£

### ğŸ–¼ï¸ æ¨¡æ€1ï¼šå›¾åƒ-å›¾åƒæ£€ç´¢ (Image-to-Image Retrieval)

**åŸç†**ï¼šç›´æ¥å°†æŸ¥è¯¢å›¾åƒçš„è§†è§‰ç‰¹å¾ä¸çŸ¥è¯†åº“ä¸­å„ç±»åˆ«çš„å›¾åƒç‰¹å¾è¿›è¡Œæ¯”è¾ƒ

**å®ç°æµç¨‹**ï¼š
```python
# 1. æå–æŸ¥è¯¢å›¾åƒçš„CLIPç‰¹å¾
query_img_feat = CLIP_encode(query_image)

# 2. ä¸å›¾åƒçŸ¥è¯†åº“ä¸­æ¯ä¸ªç±»åˆ«çš„å›¾åƒç‰¹å¾è®¡ç®—ç›¸ä¼¼åº¦
for category, img_feat in image_knowledge_base.items():
    similarity = cosine_similarity(query_img_feat, img_feat)
    results.append((category, similarity))

# 3. æŒ‰ç›¸ä¼¼åº¦æ’åºï¼Œè¿”å›Top-K
img_img_results = sorted(results, reverse=True)[:top_k]
```

**ä»£ç å®ç°**ï¼š
```python
# 1. å›¾åƒ-å›¾åƒæ£€ç´¢
img_img_results = self.kb_builder.image_retrieval(query_image_path, top_k)
```

**ç‰¹ç‚¹**ï¼š
- çº¯è§†è§‰ä¿¡æ¯åŒ¹é…
- é€‚åˆæ•æ‰è§†è§‰ç›¸ä¼¼æ€§ï¼ˆé¢œè‰²ã€çº¹ç†ã€å½¢çŠ¶ç­‰ï¼‰
- æƒé‡ï¼š**0.4**ï¼ˆæœ€é«˜æƒé‡ï¼Œå› ä¸ºè§†è§‰ä¿¡æ¯æœ€ç›´æ¥ï¼‰

---

### ğŸ”„ æ¨¡æ€2ï¼šå›¾åƒ-æ–‡æœ¬æ£€ç´¢ (Image-to-Text Retrieval)

**åŸç†**ï¼šå°†æŸ¥è¯¢å›¾åƒçš„è§†è§‰ç‰¹å¾ä¸çŸ¥è¯†åº“ä¸­å„ç±»åˆ«çš„æ–‡æœ¬æè¿°ç‰¹å¾è¿›è¡Œè·¨æ¨¡æ€åŒ¹é…

**å®ç°æµç¨‹**ï¼š
```python
# 1. æå–æŸ¥è¯¢å›¾åƒçš„CLIPå›¾åƒç‰¹å¾
query_img_feat = CLIP_image_encode(query_image)

# 2. ä¸æ–‡æœ¬çŸ¥è¯†åº“ä¸­æ¯ä¸ªç±»åˆ«çš„æ–‡æœ¬ç‰¹å¾è®¡ç®—è·¨æ¨¡æ€ç›¸ä¼¼åº¦
for category, text_feat in text_knowledge_base.items():
    # è·¨æ¨¡æ€ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆCLIPçš„æ ¸å¿ƒèƒ½åŠ›ï¼‰
    similarity = cosine_similarity(query_img_feat, text_feat)
    results.append((category, similarity))

# 3. æŒ‰ç›¸ä¼¼åº¦æ’åºï¼Œè¿”å›Top-K
img_text_results = sorted(results, reverse=True)[:top_k]
```

**ä»£ç å®ç°**ï¼š
```python
# 2. å›¾åƒ-æ–‡æœ¬æ£€ç´¢ï¼ˆè·¨æ¨¡æ€åŒ¹é…ï¼‰
img_feat = self.kb_builder.retrieval.extract_image_feat(query_image_path)
img_text_similarities = []
for category, text_feat in self.kb_builder.text_knowledge_base.items():
    sim = np.dot(img_feat, text_feat)  # CLIPè·¨æ¨¡æ€ç›¸ä¼¼åº¦
    img_text_similarities.append((category, sim))
img_text_results = sorted(img_text_similarities, key=lambda x: x[1], reverse=True)[:top_k]
```

**ç‰¹ç‚¹**ï¼š
- åˆ©ç”¨CLIPçš„è·¨æ¨¡æ€èƒ½åŠ›
- å°†è§†è§‰ä¿¡æ¯æ˜ å°„åˆ°è¯­ä¹‰ç©ºé—´
- æƒé‡ï¼š**0.3**

---

### ğŸ“ æ¨¡æ€3ï¼šæ–‡æœ¬-æ–‡æœ¬æ£€ç´¢ (Text-to-Text Retrieval)

**åŸç†**ï¼šå°†æ…¢æ€è€ƒç”Ÿæˆçš„ç»“æ„åŒ–æè¿°ä¸çŸ¥è¯†åº“ä¸­å„ç±»åˆ«çš„æ–‡æœ¬æè¿°è¿›è¡Œè¯­ä¹‰åŒ¹é…

**å®ç°æµç¨‹**ï¼š
```python
# 1. æå–æŸ¥è¯¢çš„ç»“æ„åŒ–æè¿°çš„CLIPæ–‡æœ¬ç‰¹å¾
structured_description = "A medium-sized dog with pointed ears, short brown coat, ..."
query_text_feat = CLIP_text_encode(structured_description)

# 2. ä¸æ–‡æœ¬çŸ¥è¯†åº“ä¸­æ¯ä¸ªç±»åˆ«çš„æ–‡æœ¬ç‰¹å¾è®¡ç®—è¯­ä¹‰ç›¸ä¼¼åº¦
for category, text_feat in text_knowledge_base.items():
    similarity = cosine_similarity(query_text_feat, text_feat)
    results.append((category, similarity))

# 3. æŒ‰ç›¸ä¼¼åº¦æ’åºï¼Œè¿”å›Top-K
text_text_results = sorted(results, reverse=True)[:top_k]
```

**ä»£ç å®ç°**ï¼š
```python
# 3. æ–‡æœ¬-æ–‡æœ¬æ£€ç´¢ï¼ˆè¯­ä¹‰åŒ¹é…ï¼‰
text_feat = self.kb_builder.retrieval.extract_text_feat(structured_description)
text_text_similarities = []
for category, text_kb_feat in self.kb_builder.text_knowledge_base.items():
    sim = np.dot(text_feat, text_kb_feat)  # è¯­ä¹‰ç›¸ä¼¼åº¦
    text_text_similarities.append((category, sim))
text_text_results = sorted(text_text_similarities, key=lambda x: x[1], reverse=True)[:top_k]
```

**ç‰¹ç‚¹**ï¼š
- çº¯è¯­ä¹‰ä¿¡æ¯åŒ¹é…
- åˆ©ç”¨MLLMç”Ÿæˆçš„ä¸°å¯Œç»“æ„åŒ–æè¿°
- æƒé‡ï¼š**0.3**

---

## ğŸ”— ä¸‰æ¨¡æ€èåˆç­–ç•¥

### èåˆç®—æ³•
```python
# 1. æ”¶é›†ä¸‰ä¸ªæ¨¡æ€çš„æ£€ç´¢ç»“æœ
all_candidates = {}

# å›¾åƒ-å›¾åƒæ£€ç´¢ç»“æœï¼ˆæƒé‡0.4ï¼‰
for category, score in img_img_results:
    all_candidates[category] = all_candidates.get(category, []) + [score * 0.4]

# å›¾åƒ-æ–‡æœ¬æ£€ç´¢ç»“æœï¼ˆæƒé‡0.3ï¼‰  
for category, score in img_text_results:
    all_candidates[category] = all_candidates.get(category, []) + [score * 0.3]

# æ–‡æœ¬-æ–‡æœ¬æ£€ç´¢ç»“æœï¼ˆæƒé‡0.3ï¼‰
for category, score in text_text_results:
    all_candidates[category] = all_candidates.get(category, []) + [score * 0.3]

# 2. ä½¿ç”¨æœ€å¤§å€¼ç­–ç•¥èåˆ
fused_results = []
for category, scores in all_candidates.items():
    fused_score = max(scores)  # å–æœ€å¤§å€¼è€Œéå¹³å‡å€¼
    fused_results.append((category, fused_score))

# 3. æ’åºè¿”å›Top-K
return sorted(fused_results, key=lambda x: x[1], reverse=True)[:top_k]
```

### ä¸ºä»€ä¹ˆä½¿ç”¨æœ€å¤§å€¼ç­–ç•¥ï¼Ÿ
- **äº’è¡¥æ€§åŸç†**ï¼šä¸‰ä¸ªæ¨¡æ€å¯èƒ½åœ¨ä¸åŒæ–¹é¢è¡¨ç°å‡ºè‰²
- **ç½®ä¿¡åº¦ä¿æŒ**ï¼šä¿ç•™æœ€å¼ºçš„åŒ¹é…ä¿¡å·
- **å™ªå£°é²æ£’æ€§**ï¼šé¿å…å¼±åŒ¹é…æ‹‰ä½æ•´ä½“åˆ†æ•°

---

## ğŸ“Š ä¸‰æ¨¡æ€æƒé‡è®¾è®¡åŸç†

| æ¨¡æ€ | æƒé‡ | åŸç† |
|------|------|------|
| å›¾åƒ-å›¾åƒ | **0.4** | è§†è§‰ä¿¡æ¯æœ€ç›´æ¥ï¼Œç»†ç²’åº¦ç‰¹å¾æœ€ä¸°å¯Œ |
| å›¾åƒ-æ–‡æœ¬ | **0.3** | è·¨æ¨¡æ€åŒ¹é…ï¼Œåˆ©ç”¨CLIPè¯­ä¹‰ç†è§£èƒ½åŠ› |
| æ–‡æœ¬-æ–‡æœ¬ | **0.3** | è¯­ä¹‰åŒ¹é…ï¼Œåˆ©ç”¨MLLMç”Ÿæˆçš„ç»“æ„åŒ–æè¿° |

**æƒé‡åˆè®¡**ï¼š0.4 + 0.3 + 0.3 = 1.0

---

## ğŸ”„ ä¸å¿«æ€è€ƒåŒæ¨¡æ€æ£€ç´¢çš„å¯¹æ¯”

### å¿«æ€è€ƒï¼ˆåŒæ¨¡æ€ï¼‰
```python
# åªæœ‰ä¸¤ç§æ£€ç´¢æ–¹å¼
img_results = image_to_image_retrieval()      # å›¾åƒâ†’å›¾åƒ
text_results = image_to_text_retrieval()     # å›¾åƒâ†’æ–‡æœ¬ï¼ˆè·¨æ¨¡æ€ï¼‰

# ä½¿ç”¨RRF+æ¦‚ç‡èåˆ
fused = fuse_results(img_results, text_results)
```

### æ…¢æ€è€ƒï¼ˆä¸‰æ¨¡æ€ï¼‰
```python
# ä¸‰ç§æ£€ç´¢æ–¹å¼
img_img_results = image_to_image_retrieval()     # å›¾åƒâ†’å›¾åƒ  
img_text_results = image_to_text_retrieval()    # å›¾åƒâ†’æ–‡æœ¬ï¼ˆè·¨æ¨¡æ€ï¼‰
text_text_results = text_to_text_retrieval()    # æ–‡æœ¬â†’æ–‡æœ¬ï¼ˆè¯­ä¹‰ï¼‰

# ä½¿ç”¨åŠ æƒæœ€å¤§å€¼èåˆ
fused = weighted_max_fusion(img_img, img_text, text_text)
```

---

## ğŸ¯ ä¸‰æ¨¡æ€æ£€ç´¢çš„ä¼˜åŠ¿

### 1. **ä¿¡æ¯äº’è¡¥æ€§**
- **è§†è§‰æ¨¡æ€**ï¼šæ•æ‰é¢œè‰²ã€çº¹ç†ã€å½¢çŠ¶ç­‰ä½çº§ç‰¹å¾
- **è·¨æ¨¡æ€**ï¼šåˆ©ç”¨è§†è§‰-è¯­ä¹‰æ˜ å°„èƒ½åŠ›
- **è¯­ä¹‰æ¨¡æ€**ï¼šåˆ©ç”¨ä¸°å¯Œçš„æ–‡æœ¬æè¿°ä¿¡æ¯

### 2. **é²æ£’æ€§å¢å¼º**
- å•ä¸€æ¨¡æ€å¤±æ•ˆæ—¶ï¼Œå…¶ä»–æ¨¡æ€å¯ä»¥è¡¥å¿
- å‡å°‘å› è§†è§‰ç›¸ä¼¼ä½†è¯­ä¹‰ä¸åŒå¯¼è‡´çš„è¯¯åˆ†ç±»

### 3. **ç²¾åº¦æå‡**
- ç»“åˆäº†CLIPçš„è·¨æ¨¡æ€èƒ½åŠ›å’ŒMLLMçš„è¯­è¨€ç†è§£èƒ½åŠ›
- é€šè¿‡ç»“æ„åŒ–æè¿°æä¾›æ›´ç²¾ç¡®çš„è¯­ä¹‰ä¿¡æ¯

### 4. **é€‚åº”æ€§å¼º**
- å¯¹äºè§†è§‰ç›¸ä¼¼åº¦é«˜çš„ç»†ç²’åº¦åˆ†ç±»æ›´æœ‰æ•ˆ
- èƒ½å¤Ÿå¤„ç†å¤æ‚çš„å±æ€§ç»„åˆå’Œç»†å¾®å·®åˆ«

---

## ğŸ” å®é™…æ£€ç´¢ç¤ºä¾‹

å‡è®¾æŸ¥è¯¢å›¾åƒæ˜¯ä¸€åª**å¾·å›½ç‰§ç¾ŠçŠ¬**ï¼š

### ç»“æ„åŒ–æè¿°ç”Ÿæˆ
```
"A large dog with erect pointed ears, medium-length double coat in black and tan colors, 
strong muscular build, intelligent expression, and distinctive wolf-like facial features."
```

### ä¸‰æ¨¡æ€æ£€ç´¢ç»“æœ
```python
# å›¾åƒ-å›¾åƒæ£€ç´¢ (æƒé‡0.4)
img_img_results = [
    ("German Shepherd", 0.89),
    ("Belgian Malinois", 0.82), 
    ("Siberian Husky", 0.75)
]

# å›¾åƒ-æ–‡æœ¬æ£€ç´¢ (æƒé‡0.3)  
img_text_results = [
    ("German Shepherd", 0.91),
    ("Belgian Malinois", 0.78),
    ("Dutch Shepherd", 0.74)
]

# æ–‡æœ¬-æ–‡æœ¬æ£€ç´¢ (æƒé‡0.3)
text_text_results = [
    ("German Shepherd", 0.88),
    ("Belgian Malinois", 0.73),
    ("Rottweiler", 0.69)
]

# èåˆç»“æœ
final_results = [
    ("German Shepherd", max(0.89*0.4, 0.91*0.3, 0.88*0.3) = 0.356),
    ("Belgian Malinois", max(0.82*0.4, 0.78*0.3, 0.73*0.3) = 0.328),
    ...
]
```

é€šè¿‡ä¸‰æ¨¡æ€æ£€ç´¢ï¼Œç³»ç»Ÿèƒ½å¤Ÿä»å¤šä¸ªè§’åº¦éªŒè¯"å¾·å›½ç‰§ç¾ŠçŠ¬"çš„åˆ†ç±»ç»“æœï¼Œæé«˜äº†è¯†åˆ«çš„å¯é æ€§å’Œå‡†ç¡®æ€§ã€‚

---

## ğŸ“ˆ æ€»ç»“

æ…¢æ€è€ƒçš„ä¸‰æ¨¡æ€æ£€ç´¢æ˜¯ç³»ç»Ÿçš„é‡è¦åˆ›æ–°ï¼Œé€šè¿‡ï¼š
- **å›¾åƒ-å›¾åƒæ£€ç´¢**ï¼šçº¯è§†è§‰åŒ¹é…
- **å›¾åƒ-æ–‡æœ¬æ£€ç´¢**ï¼šè·¨æ¨¡æ€ç†è§£  
- **æ–‡æœ¬-æ–‡æœ¬æ£€ç´¢**ï¼šè¯­ä¹‰æ¨ç†

ä¸‰è€…ç»“åˆï¼Œå®ç°äº†æ¯”å¿«æ€è€ƒæ›´æ·±å…¥ã€æ›´å‡†ç¡®çš„ç»†ç²’åº¦è§†è§‰è¯†åˆ«ã€‚è¿™ç§è®¾è®¡ç‰¹åˆ«é€‚åˆå¤„ç†è§†è§‰ç›¸ä¼¼ä½†è¯­ä¹‰ä¸åŒçš„å›°éš¾æ ·æœ¬ã€‚
