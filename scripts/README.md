# è„šæœ¬ä½¿ç”¨è¯´æ˜

æœ¬ç›®å½•åŒ…å«äº†å¿«æ…¢æ€è€ƒç³»ç»Ÿçš„å„ç§è¿è¡Œè„šæœ¬ï¼Œæ”¯æŒäº”ä¸ªæ•°æ®é›†ï¼Œ**æ‰€æœ‰é…ç½®å‚æ•°éƒ½åœ¨ `config.yaml` æ–‡ä»¶ä¸­ç»Ÿä¸€ç®¡ç†**ã€‚

## æ”¯æŒçš„æ•°æ®é›†

| æ•°æ®é›† | DATASET | ç±»åˆ«æ•° | é…ç½®æ–‡ä»¶ | æ•°æ®ç›®å½• |
|---------|---------|---------|-------------|-------------|
| ç‹—ç±» | dog | 120 | dog120_all.yml | dogs_120 |
| é¸Ÿç±» | bird | 200 | bird200_all.yml | CUB_200_2011 |
| èŠ±ç±» | flower | 102 | flower102_all.yml | flowers_102 |
| å® ç‰© | pet | 37 | pet37_all.yml | pet_37 |
| è½¦ç±» | car | 196 | car196_all.yml | car_196 |

## è„šæœ¬åˆ—è¡¨

### 1. run_discovery.sh
- **åŠŸèƒ½**: é€šç”¨å‘ç°è„šæœ¬ï¼Œæ”¯æŒå››ç§æ¨¡å¼
- **æ”¯æŒæ¨¡å¼**: 
  - `build_knowledge_base`: æ„å»ºçŸ¥è¯†åº“
  - `fastonly`: ä»…å¿«æ€è€ƒè¯„ä¼°
  - `slowonly`: ä»…æ…¢æ€è€ƒè¯„ä¼°  
  - `fast_slow`: å¿«æ…¢æ€è€ƒè”åˆè¯„ä¼°
- **ç”¨æ³•**: `bash run_discovery.sh`
- **è¯´æ˜**: ä¿®æ”¹è„šæœ¬ä¸­çš„MODEå˜é‡æ¥é€‰æ‹©è¿è¡Œæ¨¡å¼

### 2. run_build_knowledge_base.sh
- **åŠŸèƒ½**: ä¸“é—¨ç”¨äºæ„å»ºçŸ¥è¯†åº“
- **æ¨¡å¼**: ä»…æ”¯æŒ `build_knowledge_base`
- **ç”¨æ³•**: `bash run_build_knowledge_base.sh`
- **è¯´æ˜**: æ„å»ºå¿«æ…¢æ€è€ƒç³»ç»Ÿæ‰€éœ€çš„çŸ¥è¯†åº“æ–‡ä»¶

### 3. run_fast_slow.sh
- **åŠŸèƒ½**: ä¸“é—¨ç”¨äºå¿«æ…¢æ€è€ƒç³»ç»Ÿè¯„ä¼°
- **æ¨¡å¼**: ä»…æ”¯æŒ `fast_slow`
- **ç”¨æ³•**: `bash run_fast_slow.sh`
- **è¯´æ˜**: éœ€è¦å…ˆè¿è¡ŒçŸ¥è¯†åº“æ„å»ºè„šæœ¬

### 4. run_full_pipeline.sh
- **åŠŸèƒ½**: å®Œæ•´æµç¨‹è„šæœ¬
- **æµç¨‹**: å…ˆæ„å»ºçŸ¥è¯†åº“ â†’ ç„¶åè¿›è¡Œå¿«æ…¢æ€è€ƒè¯„ä¼°
- **ç”¨æ³•**: `bash run_full_pipeline.sh`
- **è¯´æ˜**: è‡ªåŠ¨æ‰§è¡Œå®Œæ•´çš„çŸ¥è¯†åº“æ„å»ºå’Œè¯„ä¼°æµç¨‹

### 5. run_fast_slow_infer.sh â­ **æ–°å¢**
- **åŠŸèƒ½**: å¿«æ…¢æ€è€ƒæ¨ç†é˜¶æ®µ
- **æ¨¡å¼**: ä»…æ”¯æŒ `fast_slow_infer`
- **ç”¨æ³•**: `bash run_fast_slow_infer.sh`
- **è¯´æ˜**: æ‰§è¡Œå¿«æ…¢æ€è€ƒæ¨ç†å¹¶ä¿å­˜ä¸­é—´ç»“æœï¼Œä¾¿äºåç»­æ¶ˆèå®éªŒ

### 6. run_fast_slow_classify.sh â­ **æ–°å¢**
- **åŠŸèƒ½**: å¿«æ…¢æ€è€ƒåˆ†ç±»é˜¶æ®µ
- **æ¨¡å¼**: ä»…æ”¯æŒ `fast_slow_classify`
- **ç”¨æ³•**: `bash run_fast_slow_classify.sh`
- **è¯´æ˜**: åŸºäºæ¨ç†ç»“æœæ‰§è¡Œåˆ†ç±»é€»è¾‘ï¼Œéœ€è¦å…ˆè¿è¡Œæ¨ç†è„šæœ¬

### 7. run_fast_slow_pipeline.sh â­ **æ–°å¢**
- **åŠŸèƒ½**: å¿«æ…¢æ€è€ƒåˆ†ç¦»æµç¨‹è„šæœ¬
- **æµç¨‹**: å…ˆæ‰§è¡Œæ¨ç† â†’ ç„¶åæ‰§è¡Œåˆ†ç±»
- **ç”¨æ³•**: `bash run_fast_slow_pipeline.sh`
- **è¯´æ˜**: è‡ªåŠ¨æ‰§è¡Œå®Œæ•´çš„æ¨ç†å’Œåˆ†ç±»åˆ†ç¦»æµç¨‹

### 8. test_config.sh
- **åŠŸèƒ½**: é…ç½®æ–‡ä»¶æµ‹è¯•è„šæœ¬
- **ç”¨æ³•**: `bash test_config.sh`
- **è¯´æ˜**: æµ‹è¯• config.yaml é…ç½®æ–‡ä»¶çš„è¯»å–æ˜¯å¦æ­£å¸¸

## ä½¿ç”¨æ–¹æ³•

### ç¬¬é›¶æ­¥ï¼šæµ‹è¯•é…ç½®ï¼ˆå¯é€‰ï¼‰
```bash
# æµ‹è¯•é…ç½®æ–‡ä»¶æ˜¯å¦æ­£å¸¸
bash test_config.sh
```

### ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶
æ‰€æœ‰å‚æ•°éƒ½åœ¨ `config.yaml` æ–‡ä»¶ä¸­é…ç½®ï¼š

```yaml
# ä¿®æ”¹æ•°æ®é›†
dataset:
  name: "dog"                 # æ”¹ä¸º: dog, bird, flower, pet, car
  test_data_suffix: "10"      # æµ‹è¯•æ•°æ®åç¼€

# ä¿®æ”¹GPU
gpu:
  cuda_visible_devices: "4"  # ä¿®æ”¹GPUç¼–å·

# ä¿®æ”¹è¶…å‚æ•°
hyperparameters:
  kshot: 3                    # K-shot learning

# ä¿®æ”¹è¿è¡Œæ¨¡å¼
modes:
  discovery_mode: "build_knowledge_base"  # ä»…run_discovery.shä½¿ç”¨
  eval_mode: "fast_slow"                  # è¯„ä¼°æ¨¡å¼
```

### ç¬¬äºŒæ­¥ï¼šè¿è¡Œè„šæœ¬

#### ä¼ ç»Ÿæ–¹å¼ï¼šå•ç‹¬è¿è¡Œ
```bash
# 1. æ„å»ºçŸ¥è¯†åº“
bash run_build_knowledge_base.sh

# 2. è¿›è¡Œå¿«æ…¢æ€è€ƒè¯„ä¼°
bash run_fast_slow.sh
```

#### ä¼ ç»Ÿæ–¹å¼ï¼šå®Œæ•´æµç¨‹
```bash
# ä¸€é”®è¿è¡Œå®Œæ•´æµç¨‹
bash run_full_pipeline.sh
```

#### â­ **æ–°æ–¹å¼ï¼šåˆ†ç¦»å¼è¿è¡Œï¼ˆæ¨èç”¨äºæ¶ˆèå®éªŒï¼‰**
```bash
# æ–¹å¼1: åˆ†æ­¥æ‰§è¡Œ
# 1. æ„å»ºçŸ¥è¯†åº“
bash run_build_knowledge_base.sh

# 2. æ‰§è¡Œæ¨ç†é˜¶æ®µï¼ˆä¿å­˜ä¸­é—´ç»“æœï¼‰
bash run_fast_slow_infer.sh

# 3. æ‰§è¡Œåˆ†ç±»é˜¶æ®µï¼ˆåŸºäºä¸­é—´ç»“æœï¼‰
bash run_fast_slow_classify.sh

# æ–¹å¼2: ä¸€é”®åˆ†ç¦»æµç¨‹
bash run_fast_slow_pipeline.sh
```

#### çµæ´»ä½¿ç”¨
```bash
# ä½¿ç”¨é€šç”¨è„šæœ¬
bash run_discovery.sh
```

### å¿«é€Ÿåˆ‡æ¢æ•°æ®é›†ç¤ºä¾‹
```bash
# åˆ‡æ¢åˆ°é¸Ÿç±»æ•°æ®é›†
# ä¿®æ”¹ config.yaml ä¸­çš„ dataset.name: "bird"
bash run_full_pipeline.sh

# åˆ‡æ¢åˆ°èŠ±ç±»æ•°æ®é›†
# ä¿®æ”¹ config.yaml ä¸­çš„ dataset.name: "flower"
bash run_build_knowledge_base.sh

## é…ç½®è¯´æ˜

### config.yaml æ–‡ä»¶ç»“æ„

```yaml
# GPUé…ç½®
gpu:
  cuda_visible_devices: "4"    # GPUç¼–å·ï¼Œå¤šGPUç”¨é€—å·åˆ†éš”

# æ•°æ®é›†é…ç½®
dataset:
  name: "dog"                   # æ•°æ®é›†: dog, bird, flower, pet, car
  test_data_suffix: "10"        # æµ‹è¯•æ•°æ®åç¼€: 1, 3, 5, 10

# æ¨¡å‹è¶…å‚æ•°
hyperparameters:
  kshot: 3                      # K-shot learning çš„ K å€¼

# è¿è¡Œæ¨¡å¼
modes:
  discovery_mode: "build_knowledge_base"  # run_discovery.sh çš„æ¨¡å¼
  eval_mode: "fast_slow"                  # è¯„ä¼°æ¨¡å¼

# ç¯å¢ƒé…ç½®
environment:
  conda_env: "finer_dynamic"              # condaç¯å¢ƒå
  conda_base: "/home/hdl/miniconda3"      # condaè·¯å¾„
  project_root: "/home/hdl/project/fgvr_test"  # é¡¹ç›®æ ¹ç›®å½•

# æ—¥å¿—é…ç½®
logging:
  base_dir: "/home/hdl/project/fgvr_test/logs"  # æ—¥å¿—ç›®å½•
```

### ä¸»è¦é…ç½®å‚æ•°

| å‚æ•° | ä½ç½® | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|--------|
| **æ•°æ®é›†** | `dataset.name` | æ•°æ®é›†é€‰æ‹© | "dog" |
| **GPU** | `gpu.cuda_visible_devices` | GPUç¼–å· | "4" |
| **K-shot** | `hyperparameters.kshot` | æ¯ç±»æ ·æœ¬æ•° | 3 |
| **æµ‹è¯•åç¼€** | `dataset.test_data_suffix` | æ¯ä¸ªç±»åˆ«çš„æµ‹è¯•æ ·æœ¬æ•° | "10" |
| **å‘ç°æ¨¡å¼** | `modes.discovery_mode` | run_discovery.shæ¨¡å¼ | "build_knowledge_base" |
| **è¯„ä¼°æ¨¡å¼** | `modes.eval_mode` | è¯„ä¼°æ¨¡å¼ | "fast_slow" |

### æµ‹è¯•æ•°æ®åç¼€è¯´æ˜

`test_data_suffix` å‚æ•°æ§åˆ¶æ¯ä¸ªç±»åˆ«ä½¿ç”¨çš„æµ‹è¯•æ ·æœ¬æ•°é‡ï¼š

| åç¼€å€¼ | å«ä¹‰ | é€‚ç”¨åœºæ™¯ |
|---------|------|----------|
| "1" | æ¯ä¸ªç±»åˆ«1ä¸ªæ ·æœ¬ | å¿«é€Ÿæµ‹è¯• |
| "3" | æ¯ä¸ªç±»åˆ«3ä¸ªæ ·æœ¬ | å°è§„æ¨¡æµ‹è¯• |
| "5" | æ¯ä¸ªç±»åˆ«5ä¸ªæ ·æœ¬ | ä¸­ç­‰è§„æ¨¡æµ‹è¯• |
| "10" | æ¯ä¸ªç±»åˆ«10ä¸ªæ ·æœ¬ | å®Œæ•´æµ‹è¯•ï¼ˆæ¨èï¼‰ |
| "random" | éšæœºæ•°é‡çš„æ ·æœ¬ | éšæœºæµ‹è¯• |

**ä¸åŒæ•°æ®é›†çš„å»ºè®®é…ç½®ï¼š**
- **å® ç‰©æ•°æ®é›† (pet_37)**: ç±»åˆ«æ•°è¾ƒå°‘ï¼Œå»ºè®®ä½¿ç”¨ `"5"` æˆ– `"10"`
- **ç‹—ç±»æ•°æ®é›† (dog120)**: ç±»åˆ«æ•°ä¸­ç­‰ï¼Œå»ºè®®ä½¿ç”¨ `"3"` æˆ– `"5"`
- **é¸Ÿç±»æ•°æ®é›† (bird200)**: ç±»åˆ«æ•°è¾ƒå¤šï¼Œå»ºè®®ä½¿ç”¨ `"1"` æˆ– `"3"`

### è‡ªåŠ¨é…ç½®
ä»¥ä¸‹å‚æ•°ä¼šæ ¹æ® `dataset.name` è‡ªåŠ¨é…ç½®ï¼š
- **ç±»åˆ«æ•°**: æ•°æ®é›†çš„ç±»åˆ«æ•°é‡
- **é…ç½®æ–‡ä»¶**: discovering.py çš„é…ç½®æ–‡ä»¶
- **æ•°æ®ç›®å½•**: æ•°æ®é›†åœ¨ datasets/ ä¸‹çš„ç›®å½•å
- **è·¯å¾„ç”Ÿæˆ**: çŸ¥è¯†åº“ã€æµ‹è¯•æ•°æ®ã€ç»“æœè¾“å‡ºè·¯å¾„

## æ–°å¢åŠŸèƒ½ç‰¹ç‚¹

### ğŸ”„ åˆ†ç¦»å¼å¿«æ…¢æ€è€ƒæµç¨‹
æ–°å¢çš„åˆ†ç¦»å¼è„šæœ¬æä¾›ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **æ¨ç†ä¸åˆ†ç±»åˆ†ç¦»**: 
   - `fast_slow_infer`: æ‰§è¡Œæ¨ç†å¹¶ä¿å­˜æ‰€æœ‰ä¸­é—´ç»“æœ
   - `fast_slow_classify`: åŸºäºä¿å­˜çš„ç»“æœæ‰§è¡Œåˆ†ç±»é€»è¾‘

2. **æ¶ˆèå®éªŒå‹å¥½**:
   - æ¨ç†é˜¶æ®µåªéœ€è¿è¡Œä¸€æ¬¡ï¼Œåˆ†ç±»é˜¶æ®µå¯é‡å¤è¿è¡Œ
   - ä¾¿äºæµ‹è¯•ä¸åŒçš„åˆ†ç±»ç­–ç•¥å’Œèåˆæ–¹æ³•
   - å¤§å¹…å‡å°‘å®éªŒæ—¶é—´æˆæœ¬

3. **ç»“æœä¿å­˜ä½ç½®**:
   - æ¨ç†ç»“æœ: `experiments/<dataset><num>/infer/`
   - åˆ†ç±»ç»“æœ: `experiments/<dataset><num>/classify/`

4. **ä¸‰ç§åˆ†ç±»è·¯å¾„æ”¯æŒ**:
   - å¿«æ€è€ƒç›´æ¥åˆ†ç±» (`decision_path: "fast_only"`)
   - æ…¢æ€è€ƒä¸€è‡´åˆ†ç±» (`decision_path: "slow_consistent"`)
   - å¿«æ…¢ä¸ä¸€è‡´è£å†³ (`decision_path: "final_arbitration"`)

### ğŸ“Š è¯¦ç»†ç»“æœè®°å½•
åˆ†ç±»ç»“æœåŒ…å«å®Œæ•´çš„å†³ç­–è·¯å¾„ä¿¡æ¯ï¼Œä¾¿äºæ·±åº¦åˆ†æï¼š
```json
{
  "decision_path": "final_arbitration",
  "fast_slow_consistent": false,
  "fast_prediction": "Chihuahua",
  "slow_prediction": "Pomeranian",
  "final_prediction": "Pomeranian"
}
```

## æ³¨æ„äº‹é¡¹

1. **ä¾èµ–å…³ç³»**: 
   - è¯„ä¼°è„šæœ¬éœ€è¦å…ˆè¿è¡ŒçŸ¥è¯†åº“æ„å»º
   - `fast_slow_classify` éœ€è¦å…ˆè¿è¡Œ `fast_slow_infer`
2. **ç¯å¢ƒæ£€æŸ¥**: ç¡®ä¿condaç¯å¢ƒ `finer_dynamic` å·²æ­£ç¡®é…ç½®
3. **GPUè®¾ç½®**: æ ¹æ®å¯ç”¨GPUä¿®æ”¹CUDA_VISIBLE_DEVICES
4. **æ•°æ®è·¯å¾„**: ç¡®ä¿æµ‹è¯•æ•°æ®ç›®å½•å­˜åœ¨
5. **æ—¥å¿—ç›‘æ§**: ä½¿ç”¨ `tail -f` æŸ¥çœ‹å®æ—¶æ—¥å¿—
6. **å­˜å‚¨ç©ºé—´**: æ¨ç†ç»“æœä¼šå ç”¨ä¸€å®šå­˜å‚¨ç©ºé—´ï¼Œæ³¨æ„ç£ç›˜å®¹é‡
