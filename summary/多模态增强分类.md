# å¤šæ¨¡æ€å¢å¼ºåˆ†ç±»ï¼ˆMECï¼‰æ¡†æ¶è®¾è®¡ä¸å®ç°

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† `Multimodal_Enhanced_Classification` æ¡†æ¶çš„è®¾è®¡ã€å®ç°ä»¥åŠä¸ `discovering.py` å¿«æ…¢æ€è€ƒç³»ç»Ÿçš„é›†æˆæ–¹æ¡ˆã€‚MECæ¡†æ¶ä½œä¸ºå¯æ’æ‹”çš„å¢å¼ºæ¨¡å—ï¼Œé€šè¿‡å¤šæ¨¡æ€ç‰¹å¾åŒ¹é…æå‡åˆ†ç±»æ€§èƒ½ã€‚

## æ ¸å¿ƒè®¾è®¡ç†å¿µ

### MECç®—æ³•åŸç†ï¼ˆåŠ¨æ€kå›¾åƒå¢å¼ºç‰ˆï¼‰
- **å¤šæ¨¡æ€ç‰¹å¾æå–**ï¼šä½¿ç”¨CLIPæ¨¡å‹åˆ†åˆ«ç¼–ç æµ‹è¯•å›¾åƒå’Œæ¯ä¸ªç±»åˆ«åŠ¨æ€kå¼ æ£€ç´¢å›¾åƒçš„ç‰¹å¾ï¼Œæ‹¼æ¥ä¸º `[Ti, Ii]` å¤šæ¨¡æ€ç‰¹å¾å‘é‡
- **åŠ¨æ€kå€¼è®¡ç®—**ï¼šè‡ªåŠ¨ä»`category_image_paths.json`ä¸­è®¡ç®—æ¯ä¸ªç±»åˆ«çš„å®é™…å›¾åƒæ•°é‡kï¼Œæ”¯æŒä¸åŒç±»åˆ«ä¸åŒkå€¼
- **ç†µæƒé‡è®¡ç®—**ï¼šå¯¹æµ‹è¯•å›¾åƒå’Œæ¯å¼ æ£€ç´¢å›¾åƒçš„å¤šè§†å›¾ç‰¹å¾åˆ†åˆ«è®¡ç®—ç†µæƒé‡ï¼Œä½¿ç”¨ `softmax(-entropy/temperature)` è¿›è¡ŒåŠ æƒ
- **kä¸ªåŠ æƒç›¸ä¼¼åº¦è®¡ç®—**ï¼šå¯¹æ¯ä¸ªç±»åˆ«çš„kå¼ å›¾åƒåˆ†åˆ«è®¡ç®—ä¸æµ‹è¯•å›¾åƒçš„åŠ æƒç›¸ä¼¼åº¦ï¼Œç„¶åå–å¹³å‡
- **å¹³å‡èšåˆå†³ç­–**ï¼šé€‰æ‹©å¹³å‡ç›¸ä¼¼åº¦æœ€é«˜çš„ç±»åˆ«ä½œä¸ºé¢„æµ‹ç»“æœï¼Œæé«˜åˆ†ç±»ç¨³å®šæ€§
- **çŸ¥è¯†åº“æ£€ç´¢**ï¼šåˆ©ç”¨`category_image_paths.json`ä»é¢„æ„å»ºçš„çŸ¥è¯†åº“ä¸­è·å–æ¯ä¸ªç±»åˆ«çš„æ‰€æœ‰ä»£è¡¨æ€§å›¾åƒ

### ä¸å¿«æ…¢æ€è€ƒç³»ç»Ÿçš„é›†æˆ
MECæ¡†æ¶ä½œä¸º"å¢å¼ºå™¨"æ— ç¼é›†æˆåˆ°å¿«æ…¢æ€è€ƒç³»ç»Ÿä¸­ï¼š
- **å¿«æ€è€ƒå¢å¼º**ï¼šå¯¹å¿«æ€è€ƒé¢„æµ‹ç»“æœè¿›è¡Œå¤šæ¨¡æ€éªŒè¯å’Œä¿®æ­£
- **æ…¢æ€è€ƒå¢å¼º**ï¼šä¸ºæ…¢æ€è€ƒæ¨ç†æä¾›æ›´å¼ºçš„å¤šæ¨¡æ€è¯æ®æ”¯æŒ
- **ç»ˆç«¯å†³ç­–å¢å¼º**ï¼šåœ¨å¿«æ…¢ä¸ä¸€è‡´æ—¶æä¾›å¤šæ¨¡æ€èåˆå†³ç­–

## æ¡†æ¶æ¶æ„

### æ ¸å¿ƒæ–‡ä»¶ç»“æ„
```
Multimodal_Enhanced_Classification/
â”œâ”€â”€ pre_extract.py          # å¤šæ¨¡æ€ç‰¹å¾é¢„æå–
â”œâ”€â”€ evaluate.py             # å¤šæ¨¡æ€ç›¸ä¼¼åº¦è¯„ä¼°
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ datautils.py        # æ•°æ®é›†æ„å»ºå·¥å…·
â”‚   â””â”€â”€ fewshot_datasets.py # å°‘æ ·æœ¬æ•°æ®é›†å®šä¹‰
â”œâ”€â”€ clip/
â”‚   â””â”€â”€ clip.py             # CLIPæ¨¡å‹åŠ è½½å’Œä¸‹è½½
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ mec_helper.py       # MECæµæ°´çº¿ç»Ÿä¸€æ¥å£
â””â”€â”€ README.md               # æ¡†æ¶è¯´æ˜æ–‡æ¡£
```

### å…³é”®ç»„ä»¶

#### 1. ç‰¹å¾é¢„æå–æ¨¡å— (`pre_extract.py`) - kå›¾åƒå¢å¼ºç‰ˆ
- **åŠŸèƒ½**ï¼šæ‰¹é‡æå–æµ‹è¯•é›†å’Œæ£€ç´¢é›†çš„å¤šæ¨¡æ€ç‰¹å¾ï¼ˆæ”¯æŒæ¯ä¸ªç±»åˆ«kå¼ å›¾åƒï¼‰
- **è¾“å…¥**ï¼šå›¾åƒæ•°æ®é›† + æ–‡æœ¬æè¿°JSONæ–‡ä»¶ + ç±»åˆ«å›¾åƒè·¯å¾„JSONæ–‡ä»¶
- **è¾“å‡º**ï¼šé¢„æå–çš„ç‰¹å¾æ–‡ä»¶ï¼ˆ`.pth`æ ¼å¼ï¼ŒåŒ…å«kå›¾åƒç‰¹å¾ï¼‰
- **ç‰¹ç‚¹**ï¼š
  - æ”¯æŒå¤šè§†å›¾æ•°æ®å¢å¼º
  - è‡ªåŠ¨å¤„ç†å›¾åƒå’Œæ–‡æœ¬çš„CLIPç¼–ç 
  - **kå›¾åƒå¤„ç†**ï¼šæ¯ä¸ªç±»åˆ«çš„kå¼ å›¾åƒæ‹¼æ¥æˆå¤§çš„ç‰¹å¾å¼ é‡
  - ç‰¹å¾å‘é‡L2å½’ä¸€åŒ–
  - æ‰¹é‡å¤„ç†æé«˜æ•ˆç‡

#### 2. è¯„ä¼°æ¨¡å— (`evaluate.py`) - kå›¾åƒå¢å¼ºç‰ˆ
- **åŠŸèƒ½**ï¼šåŸºäºé¢„æå–ç‰¹å¾è¿›è¡Œå¤šæ¨¡æ€ç›¸ä¼¼åº¦åŒ¹é…ï¼ˆæ”¯æŒkå›¾åƒå¹³å‡ï¼‰
- **ç®—æ³•**ï¼š
  - å¯¹æµ‹è¯•å›¾åƒå’Œæ¯å¼ æ£€ç´¢å›¾åƒåˆ†åˆ«è®¡ç®—å¤šè§†å›¾ç‰¹å¾çš„ç†µæƒé‡
  - åŠ æƒå¹³å‡å¾—åˆ°æ¯å¼ å›¾åƒçš„å•å‘é‡è¡¨ç¤º
  - **kä¸ªç›¸ä¼¼åº¦è®¡ç®—**ï¼šå¯¹æ¯ä¸ªç±»åˆ«çš„kå¼ å›¾åƒåˆ†åˆ«è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
  - **å¹³å‡èšåˆ**ï¼šå°†kä¸ªç›¸ä¼¼åº¦å–å¹³å‡ä½œä¸ºæœ€ç»ˆç±»åˆ«ç›¸ä¼¼åº¦
  - Top-1é¢„æµ‹é€‰æ‹©ï¼ˆåŸºäºå¹³å‡ç›¸ä¼¼åº¦ï¼‰
- **è¾“å‡º**ï¼šåˆ†ç±»å‡†ç¡®ç‡å’Œè¯¦ç»†é¢„æµ‹ç»“æœ

#### 3. æ•°æ®å·¥å…· (`datautils.py`)
- **åŠŸèƒ½**ï¼šæ„å»ºç¬¦åˆPyTorch ImageFolderè¦æ±‚çš„æ•°æ®é›†
- **ç‰¹ç‚¹**ï¼š
  - è‡ªåŠ¨å¤„ç†ç©ºç›®å½•é—®é¢˜
  - åˆ›å»ºdummyå›¾åƒæ»¡è¶³ImageFolderè¦æ±‚
  - æ”¯æŒå¤šç§æ•°æ®é›†æ ¼å¼
  - å¥å£®çš„é”™è¯¯å¤„ç†

#### 4. ç»Ÿä¸€æ¥å£ (`mec_helper.py`)
- **åŠŸèƒ½**ï¼šæä¾›MECæµæ°´çº¿çš„ç»Ÿä¸€è°ƒç”¨æ¥å£
- **æ ¸å¿ƒå‡½æ•°**ï¼š
  - `run_mec_pipeline()`ï¼šå®Œæ•´MECæµæ°´çº¿æ‰§è¡Œ
  - `create_mec_data_structure()`ï¼šæ•°æ®å‡†å¤‡
  - `cleanup_mec_temp_files()`ï¼šæ¸…ç†ä¸´æ—¶æ–‡ä»¶
- **ç‰¹ç‚¹**ï¼š
  - è‡ªåŠ¨æ•°æ®éªŒè¯
  - é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶
  - è¿›åº¦ç›‘æ§å’Œæ—¥å¿—è®°å½•

## ä¸discovering.pyçš„é›†æˆ

### æ–°å¢æ¨¡å¼

#### 1. fast_classify_enhancedæ¨¡å¼
```bash
python discovering.py --mode=fast_classify_enhanced --config_file_expt=./configs/expts/pet37_all.yml
```

**å®ç°é€»è¾‘**ï¼š
- æ”¶é›†å¿«æ€è€ƒæ ·æœ¬ï¼ˆ`need_slow_thinking=False`ï¼‰
- ä½¿ç”¨å¿«æ€è€ƒTop-Kå€™é€‰ä½œä¸ºæ£€ç´¢åº“
- æ„é€ æµ‹è¯•æè¿°ï¼š`f"a photo of a {fast_prediction}"`
- è°ƒç”¨MECæµæ°´çº¿è¿›è¡Œå¢å¼ºåˆ†ç±»
- è¾“å‡ºï¼š`fast_classification_results_enhanced.json`

**æ•°æ®æµ**ï¼š
```
æ¨ç†ç»“æœ â†’ å¿«æ€è€ƒæ ·æœ¬æ”¶é›† â†’ æ£€ç´¢å›¾åƒå‡†å¤‡ â†’ MECç‰¹å¾æå– â†’ MECè¯„ä¼° â†’ å¢å¼ºç»“æœ
```

#### 2. slow_classify_enhancedæ¨¡å¼
```bash
python discovering.py --mode=slow_classify_enhanced --config_file_expt=./configs/expts/pet37_all.yml
```

**å®ç°é€»è¾‘**ï¼š
- æ”¶é›†æ…¢æ€è€ƒæ ·æœ¬ï¼ˆ`need_slow_thinking=True`ï¼‰
- ä½¿ç”¨æ…¢æ€è€ƒenhanced_resultsä½œä¸ºæ£€ç´¢åº“
- æ„é€ æµ‹è¯•æè¿°ï¼šä½¿ç”¨å®Œæ•´æ…¢æ€è€ƒæ¨ç†æ–‡æœ¬
- è°ƒç”¨MECæµæ°´çº¿è¿›è¡Œå¢å¼ºåˆ†ç±»
- è¾“å‡ºï¼š`slow_classification_results_enhanced.json`

**æ•°æ®æµ**ï¼š
```
æ¨ç†ç»“æœ â†’ æ…¢æ€è€ƒæ ·æœ¬æ”¶é›† â†’ æ£€ç´¢å›¾åƒå‡†å¤‡ â†’ MECç‰¹å¾æå– â†’ MECè¯„ä¼° â†’ å¢å¼ºç»“æœ
```

#### 3. terminal_decision_enhancedæ¨¡å¼
```bash
python discovering.py --mode=terminal_decision_enhanced --config_file_expt=./configs/expts/pet37_all.yml
```

**å®ç°é€»è¾‘**ï¼š
- ä¾èµ–å‰ä¸¤ä¸ªæ¨¡å¼çš„è¾“å‡ºæ–‡ä»¶
- è¯†åˆ«éœ€è¦ç»ˆç«¯å†³ç­–çš„æ ·æœ¬ï¼ˆ`decision_path == "need_terminal_decision"`ï¼‰
- æ‰§è¡Œå¢å¼ºèåˆå†³ç­–ï¼š
  - æ¯”è¾ƒå¢å¼ºåçš„å¿«æ…¢æ€è€ƒç½®ä¿¡åº¦
  - é€‰æ‹©ç½®ä¿¡åº¦æ›´é«˜çš„é¢„æµ‹
  - è®°å½•å†³ç­–æ¥æºå’Œè´¨é‡
- è¾“å‡ºï¼š`terminal_decision_results_enhanced.json`

**èåˆç­–ç•¥**ï¼š
```python
if slow_enhanced_conf > fast_enhanced_conf:
    final_prediction = slow_enhanced_pred
    decision_source = "enhanced_slow_winner"
elif fast_enhanced_conf > slow_enhanced_conf:
    final_prediction = fast_enhanced_pred
    decision_source = "enhanced_fast_winner"
else:
    final_prediction = slow_enhanced_pred  # æ…¢æ€è€ƒæ›´è°¨æ…
    decision_source = "enhanced_slow_tie"
```

### æ•°æ®å¯¹é½ç­–ç•¥

#### çŸ¥è¯†åº“æ•°æ®æ ¼å¼å¤„ç†
```python
# å¤„ç†JSONæ•°æ®æ ¼å¼ï¼šæ”¯æŒåˆ—è¡¨å’Œå­—å…¸ä¸¤ç§æ ¼å¼
if isinstance(image_kb, list) and len(image_kb) > 0:
    image_kb = image_kb[0]
if isinstance(text_kb, list) and len(text_kb) > 0:
    text_kb = text_kb[0]
```

#### å›¾åƒæ£€ç´¢é€»è¾‘
```python
# åŸºäºç±»åˆ«åæœç´¢å®é™…å›¾åƒæ–‡ä»¶
matching_dirs = [d for d in os.listdir(img_dir) if category in d and os.path.isdir(os.path.join(img_dir, d))]
if matching_dirs:
    first_match_dir = os.path.join(img_dir, matching_dirs[0])
    img_files = [f for f in os.listdir(first_match_dir) if f.lower().endswith(('.jpg', '.jpeg', '.png', '.bmp'))]
    if img_files:
        src_img = os.path.join(first_match_dir, img_files[0])
```

#### æè¿°æ–‡ä»¶æ„é€ 
- **æµ‹è¯•æè¿°**ï¼šåŸºäºå¿«æ€è€ƒé¢„æµ‹æˆ–æ…¢æ€è€ƒæ¨ç†æ–‡æœ¬
- **æ£€ç´¢æè¿°**ï¼šä»çŸ¥è¯†åº“text_kbè·å–ç±»åˆ«æè¿°
- **æ ¼å¼**ï¼šJSONæ–‡ä»¶ï¼Œé”®ä¸ºå›¾åƒæ–‡ä»¶åï¼Œå€¼ä¸ºæè¿°æ–‡æœ¬

### æ¨¡å¼ç­‰ä»·æ€§ä¿è¯

ç¡®ä¿ä»¥ä¸‹æ‰§è¡Œè·¯å¾„äº§ç”Ÿç­‰ä»·ç»“æœï¼š
- `fast_classify + slow_classify + terminal_decision` â‰¡ `fast_slow_classify`
- `fast_classify_enhanced + slow_classify_enhanced + terminal_decision_enhanced` â‰¡ `fast_slow_classify_enhanced`

**å®ç°è¦ç‚¹**ï¼š
- ç»Ÿä¸€çš„å†³ç­–é€»è¾‘å’Œç»Ÿè®¡è®¡ç®—
- ä¸€è‡´çš„ç½®ä¿¡åº¦é˜ˆå€¼å’Œç›¸ä¼¼åº¦è®¡ç®—
- åŒæ­¥çš„ç»“æœæ›´æ–°æœºåˆ¶

## é”™è¯¯å¤„ç†ä¸è§£å†³æ–¹æ¡ˆ

### 1. JSONæ•°æ®æ ¼å¼é”™è¯¯
**é—®é¢˜**ï¼š`TypeError: list indices must be integers or slices, not str`
**åŸå› **ï¼šçŸ¥è¯†åº“JSONæ–‡ä»¶æ ¹å…ƒç´ ä¸ºåˆ—è¡¨è€Œéå­—å…¸
**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# åœ¨discovering.pyä¸­æ·»åŠ æ ¼å¼æ£€æŸ¥
if isinstance(data, list) and len(data) > 0:
    data = data[0]
```

### 2. SSLè¯ä¹¦éªŒè¯å¤±è´¥
**é—®é¢˜**ï¼š`ssl.SSLCertVerificationError: [SSL: CERTIFICATE_VERIFY_FAILED]`
**åŸå› **ï¼šCLIPæ¨¡å‹ä¸‹è½½æ—¶SSLè¯ä¹¦éªŒè¯å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# åœ¨clip.pyä¸­ç¦ç”¨SSLéªŒè¯
ssl_context = ssl.create_default_context()
ssl_context.check_hostname = False
ssl_context.verify_mode = ssl.CERT_NONE
```

### 3. SHA256æ ¡éªŒå¤±è´¥
**é—®é¢˜**ï¼š`RuntimeError: Model has been downloaded but the SHA256 checksum does not not match`
**åŸå› **ï¼šä¸‹è½½çš„æ¨¡å‹æ–‡ä»¶æ ¡éªŒå’Œä¸åŒ¹é…
**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# æ”¹ä¸ºè­¦å‘Šè€Œéé”™è¯¯ï¼Œå¢åŠ é‡è¯•æœºåˆ¶
if hashlib.sha256(open(download_target, "rb").read()).hexdigest() != expected_sha256:
    print(f"è­¦å‘Š: SHA256æ ¡éªŒå¤±è´¥ï¼Œä½†ç»§ç»­ä½¿ç”¨æ–‡ä»¶: {download_target}")
```

### 4. ImageFolderç©ºç›®å½•é”™è¯¯
**é—®é¢˜**ï¼š`FileNotFoundError: Found no valid file for the classes dummy_class`
**åŸå› **ï¼šImageFolderè¦æ±‚æ¯ä¸ªç±»åˆ«ç›®å½•è‡³å°‘åŒ…å«ä¸€ä¸ªæœ‰æ•ˆå›¾åƒæ–‡ä»¶
**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# åœ¨datautils.pyä¸­åˆ›å»ºdummyå›¾åƒ
if len(files_in_dir) == 0:
    dummy_img = Image.fromarray(np.zeros((32, 32, 3), dtype=np.uint8), 'RGB')
    dummy_img.save(os.path.join(item_path, "dummy.jpg"), 'JPEG')
```

### 5. æ£€ç´¢æ•°æ®é›†ä¸ºç©º
**é—®é¢˜**ï¼š`MECæµæ°´çº¿å¤±è´¥: æ£€ç´¢æ•°æ®é›†ä¸ºç©º`
**åŸå› **ï¼šçŸ¥è¯†åº“å­˜å‚¨çš„æ˜¯ç‰¹å¾å‘é‡è€Œéå›¾åƒè·¯å¾„
**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# åŸºäºç±»åˆ«åæœç´¢å®é™…å›¾åƒæ–‡ä»¶
matching_dirs = [d for d in os.listdir(img_dir) if category in d and os.path.isdir(os.path.join(img_dir, d))]
```

### 6. Subprocessè·¯å¾„é—®é¢˜
**é—®é¢˜**ï¼š`can't open file '/data/oldhome/hdl/project/fgvr_test/Multimodal_Enhanced_Classification/./Multimodal_Enhanced_Classification/pre_extract.py'`
**åŸå› **ï¼šsubprocessè°ƒç”¨æ—¶è·¯å¾„é‡å¤æ‹¼æ¥
**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# ä½¿ç”¨ç›¸å¯¹è·¯å¾„è€Œéç»å¯¹è·¯å¾„
cmd = [sys.executable, "pre_extract.py", data_root, ...]
```

## æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥
- **ç‰¹å¾ç¼“å­˜**ï¼šé¢„æå–çš„ç‰¹å¾ä¿å­˜åœ¨ `pre_extracted_feat/` ç›®å½•
- **æè¿°ç¼“å­˜**ï¼šæ–‡æœ¬æè¿°ä¿å­˜åœ¨ `descriptions/` ç›®å½•
- **ä¸´æ—¶æ–‡ä»¶æ¸…ç†**ï¼šè‡ªåŠ¨æ¸…ç†MECå¤„ç†è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶

### æ‰¹é‡å¤„ç†
- **æ ·æœ¬æ”¶é›†**ï¼šå…ˆæ”¶é›†æ‰€æœ‰æ ·æœ¬ï¼Œå†æ‰¹é‡è°ƒç”¨MEC
- **å¹¶è¡Œå¤„ç†**ï¼šæ”¯æŒå¿«æ…¢æ€è€ƒå¢å¼ºçš„å¹¶è¡Œæ‰§è¡Œ
- **èµ„æºæ§åˆ¶**ï¼šé™åˆ¶workeræ•°é‡å’Œè¶…æ—¶æ—¶é—´

### é”™è¯¯å›é€€
- **ä¼˜é›…é™çº§**ï¼šMECå¤±è´¥æ—¶å›é€€åˆ°åŸå§‹åˆ†ç±»ç»“æœ
- **é”™è¯¯è®°å½•**ï¼šåœ¨ç»“æœä¸­æ ‡è®°å¢å¼ºçŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯
- **ç¨³å®šæ€§ä¿è¯**ï¼šç¡®ä¿å¢å¼ºå¤±è´¥ä¸å½±å“ä¸»æµç¨‹

## ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´å¢å¼ºæµç¨‹
```bash
# 1. ç”ŸæˆåŸºç¡€æ¨ç†ç»“æœ
python discovering.py --mode=fast_slow_infer --config_file_expt=./configs/expts/pet37_all.yml

# 2. æ‰§è¡Œå¢å¼ºåˆ†ç±»
python discovering.py --mode=fast_classify_enhanced --config_file_expt=./configs/expts/pet37_all.yml
python discovering.py --mode=slow_classify_enhanced --config_file_expt=./configs/expts/pet37_all.yml

# 3. ç»ˆç«¯å†³ç­–å¢å¼º
python discovering.py --mode=terminal_decision_enhanced --config_file_expt=./configs/expts/pet37_all.yml
```

### ç»“æœæ–‡ä»¶
```
experiments/pet37/classify/
â”œâ”€â”€ fast_classification_results_enhanced.json
â”œâ”€â”€ slow_classification_results_enhanced.json
â””â”€â”€ terminal_decision_results_enhanced.json
```

### ç»Ÿè®¡æŒ‡æ ‡
- `original_accuracy`ï¼šåŸå§‹æ–¹æ³•å‡†ç¡®ç‡
- `enhanced_accuracy`ï¼šå¢å¼ºåå‡†ç¡®ç‡
- `enhancement_rate`ï¼šå¢å¼ºæå‡ç‡
- `mec_success`ï¼šMECæ‰§è¡ŒçŠ¶æ€
- `terminal_decisions`ï¼šç»ˆç«¯å†³ç­–æ ·æœ¬æ•°
- `terminal_success_rate`ï¼šç»ˆç«¯å†³ç­–æˆåŠŸç‡

## æœ€æ–°æ›´æ–°ï¼ˆ2025å¹´10æœˆ31æ—¥ï¼‰

### çŸ¥è¯†åº“å›¾åƒè·¯å¾„ä¼˜åŒ–

**æ›´æ–°å†…å®¹**ï¼š
- é‡æ„äº†AWCæ¡†æ¶çš„å›¾åƒæ£€ç´¢é€»è¾‘ï¼Œä»ç¡¬ç¼–ç è·¯å¾„æœç´¢æ”¹ä¸ºåŸºäºçŸ¥è¯†åº“çš„`category_image_paths.json`æ–‡ä»¶
- æ–°å¢äº†é€šç”¨çš„æ•°æ®é›†æ˜ å°„å‡½æ•°ï¼Œæ”¯æŒæ‰€æœ‰æ•°æ®é›†ï¼ˆpet, dog, flower, car, birdï¼‰
- ä¼˜åŒ–äº†å›¾åƒåŠ è½½æ€§èƒ½å’Œå‡†ç¡®æ€§

**æŠ€æœ¯æ”¹è¿›**ï¼š

1. **æ–°å¢è¾…åŠ©å‡½æ•°**ï¼š
   ```python
   def get_dataset_mapping():
       """è·å–æ•°æ®é›†åç§°æ˜ å°„å’Œå¯¹åº”çš„å®éªŒç›®å½•å"""
       return {
           'pet': {'dataset_dir': 'pet_37', 'exp_dir': 'pet37'},
           'dog': {'dataset_dir': 'dogs_120', 'exp_dir': 'dog120'}, 
           'flower': {'dataset_dir': 'flowers_102', 'exp_dir': 'flower102'},
           'car': {'dataset_dir': 'car_196', 'exp_dir': 'car196'},
           'bird': {'dataset_dir': 'CUB_200_2011', 'exp_dir': 'bird200'}
       }
   
   def load_category_image_paths(dataset_name):
       """ä»çŸ¥è¯†åº“åŠ è½½ç±»åˆ«å›¾åƒè·¯å¾„"""
       # ä» experiments/{dataset}/knowledge_base/category_image_paths.json åŠ è½½
   
   def get_category_image_from_paths(category, category_paths, max_images=None):
       """ä»ç±»åˆ«å›¾åƒè·¯å¾„ä¸­è·å–æŒ‡å®šæ•°é‡çš„å›¾åƒï¼ˆåŠ¨æ€kå€¼ï¼‰"""
   ```

2. **åŠ¨æ€kå›¾åƒæ£€ç´¢é€»è¾‘ä¼˜åŒ–**ï¼š
   - **åŠ¨æ€kå€¼è®¡ç®—**ï¼šè‡ªåŠ¨è®¡ç®—æ¯ä¸ªç±»åˆ«åœ¨`category_image_paths.json`ä¸­çš„å®é™…å›¾åƒæ•°é‡
   - **ä¼˜å…ˆçº§1**ï¼šä½¿ç”¨`category_image_paths.json`ä¸­çš„ç²¾ç¡®è·¯å¾„ï¼Œè·å–æ¯ä¸ªç±»åˆ«çš„æ‰€æœ‰å›¾åƒ
   - **ä¼˜å…ˆçº§2**ï¼šå›é€€åˆ°ä¼ ç»Ÿçš„å•å›¾åƒç›®å½•æœç´¢æ–¹å¼
   - **ç»Ÿè®¡ä¿¡æ¯**ï¼šæ˜¾ç¤ºkå€¼åˆ†å¸ƒç»Ÿè®¡ã€å¹³å‡å›¾åƒæ•°å’Œæ€»å›¾åƒæ•°
   - **æ‰¹é‡å¤„ç†**ï¼šåŒæ—¶å¤„ç†æ¯ä¸ªç±»åˆ«çš„å¤šå¼ å›¾åƒï¼Œæé«˜æ•ˆç‡
   - **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥å’Œé”™è¯¯æç¤º

3. **æ”¯æŒçš„æ•°æ®é›†**ï¼š
   - âœ… pet37: `experiments/pet37/knowledge_base/category_image_paths.json`
   - âœ… dog120: `experiments/dog120/knowledge_base/category_image_paths.json`
   - âœ… flower102: `experiments/flower102/knowledge_base/category_image_paths.json`
   - âœ… car196: `experiments/car196/knowledge_base/category_image_paths.json`
   - âœ… bird200: `experiments/bird200/knowledge_base/category_image_paths.json`

4. **ä¿®æ”¹çš„æ¨¡å¼**ï¼š
   - `fast_classify_enhanced`: å¿«æ€è€ƒå¢å¼ºåˆ†ç±»
   - `slow_classify_enhanced`: æ…¢æ€è€ƒå¢å¼ºåˆ†ç±»
   - `terminal_decision_enhanced`: ç»ˆç«¯å†³ç­–å¢å¼ºï¼ˆä¾èµ–å‰ä¸¤ä¸ªæ¨¡å¼ï¼‰

### åŠ¨æ€kå€¼è®¡ç®—æŠ€æœ¯ç»†èŠ‚

**æ ¸å¿ƒå®ç°é€»è¾‘**ï¼š
```python
# 1. åŠ¨æ€è®¡ç®—æ¯ä¸ªç±»åˆ«çš„kå€¼
category_k = len(category_image_paths.get(category, []))
print(f"ğŸ” ç±»åˆ« {category}: æ£€æµ‹åˆ° {category_k} å¼ å›¾åƒ")

# 2. ä½¿ç”¨å®é™…kå€¼è·å–å›¾åƒè·¯å¾„
image_paths = get_category_image_from_paths(category, category_image_paths, max_images=category_k)

# 3. ç»Ÿè®¡kå€¼åˆ†å¸ƒ
k_distribution = {}
total_images = 0
for cat, paths in category_image_paths.items():
    k = len(paths)
    k_distribution[k] = k_distribution.get(k, 0) + 1
    total_images += k

print(f"ğŸ“Š kå€¼åˆ†å¸ƒç»Ÿè®¡: {dict(sorted(k_distribution.items()))}")
print(f"ğŸ“Š å¹³å‡æ¯ç±»åˆ«å›¾åƒæ•°: {total_images / len(category_image_paths):.1f}")
```

**æŠ€æœ¯ä¼˜åŠ¿**ï¼š
- **è‡ªé€‚åº”æ€§**ï¼šæ¯ä¸ªç±»åˆ«ä½¿ç”¨å…¶å®é™…å¯ç”¨çš„å›¾åƒæ•°é‡ï¼Œæ— éœ€äººå·¥è®¾å®šå›ºå®škå€¼
- **çµæ´»æ€§**ï¼šæ”¯æŒä¸åŒç±»åˆ«æœ‰ä¸åŒçš„kå€¼ï¼Œé€‚åº”æ•°æ®é›†çš„å®é™…æƒ…å†µ
- **é€æ˜æ€§**ï¼šæä¾›è¯¦ç»†çš„kå€¼åˆ†å¸ƒç»Ÿè®¡ï¼Œä¾¿äºåˆ†æå’Œè°ƒä¼˜
- **é²æ£’æ€§**ï¼šè‡ªåŠ¨å¤„ç†ç±»åˆ«å›¾åƒæ•°é‡ä¸ä¸€è‡´çš„æƒ…å†µ

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼ˆä»¥flower102ä¸ºä¾‹ï¼‰ï¼š
- å¤§éƒ¨åˆ†ç±»åˆ«æœ‰4å¼ å›¾åƒï¼ˆå¦‚Ball Moss, Tree Poppyç­‰ï¼‰
- æŸäº›ç±»åˆ«å¯èƒ½æœ‰æ›´å¤šæˆ–æ›´å°‘çš„å›¾åƒ
- ç³»ç»Ÿä¼šè‡ªåŠ¨é€‚é…æ¯ä¸ªç±»åˆ«çš„å®é™…å›¾åƒæ•°é‡
- è¾“å‡ºç»Ÿè®¡ä¿¡æ¯ï¼š`kå€¼åˆ†å¸ƒç»Ÿè®¡: {4: 95, 5: 6, 3: 1}` è¡¨ç¤º95ä¸ªç±»åˆ«æœ‰4å¼ å›¾åƒï¼Œ6ä¸ªç±»åˆ«æœ‰5å¼ å›¾åƒï¼Œ1ä¸ªç±»åˆ«æœ‰3å¼ å›¾åƒ

**æ€§èƒ½æå‡**ï¼š
- **å‡†ç¡®æ€§**ï¼šç›´æ¥ä½¿ç”¨çŸ¥è¯†åº“æ„å»ºæ—¶çš„ç²¾ç¡®å›¾åƒè·¯å¾„ï¼Œé¿å…æ¨¡ç³ŠåŒ¹é…é”™è¯¯
- **ç¨³å®šæ€§**ï¼šé€šè¿‡åŠ¨æ€kå¼ å›¾åƒçš„å¹³å‡èšåˆï¼Œæ˜¾è‘—æé«˜åˆ†ç±»ç¨³å®šæ€§å’Œé²æ£’æ€§
- **è‡ªé€‚åº”æ€§**ï¼šæ ¹æ®æ¯ä¸ªç±»åˆ«çš„å®é™…å›¾åƒæ•°é‡è¿›è¡Œå¤„ç†ï¼Œæœ€å¤§åŒ–åˆ©ç”¨å¯ç”¨æ•°æ®
- **æ•ˆç‡**ï¼šæ‰¹é‡å¤„ç†kå¼ å›¾åƒï¼Œå‡å°‘æ–‡ä»¶ç³»ç»Ÿæœç´¢å¼€é”€
- **ç»Ÿä¸€æ€§**ï¼šç»Ÿä¸€çš„æ•°æ®é›†æ˜ å°„ï¼Œå‡å°‘ç¡¬ç¼–ç è·¯å¾„ç»´æŠ¤æˆæœ¬
- **å…¼å®¹æ€§**ï¼šä¿æŒå‘åå…¼å®¹ï¼Œæ”¯æŒä¼ ç»Ÿå•å›¾åƒæœç´¢æ–¹å¼ä½œä¸ºå›é€€

### è¾“å‡ºç»“æœä¼˜åŒ–

**ç®€åŒ–è¾“å‡ºæ˜¾ç¤º**ï¼š
ä¸ºé¿å…å¤šé‡å‡†ç¡®ç‡é€ æˆçš„æ··æ·†ï¼Œç³»ç»Ÿç°åœ¨åªæ˜¾ç¤ºæœ€ç»ˆçš„å¢å¼ºå‡†ç¡®ç‡ï¼š

```bash
âœ… å¿«æ€è€ƒå¢å¼ºåˆ†ç±»å®Œæˆ
ğŸ“Š æ€»æ ·æœ¬æ•°: 5
ğŸš€ æœ€ç»ˆå‡†ç¡®ç‡: 0.6000 (3/5)
ğŸ”§ MECæ‰§è¡ŒçŠ¶æ€: æˆåŠŸ
```

**è¾“å‡ºè¯´æ˜**ï¼š
- **ğŸš€ æœ€ç»ˆå‡†ç¡®ç‡**ï¼šç»è¿‡MECå¤šæ¨¡æ€å¢å¼ºåçš„æœ€ç»ˆåˆ†ç±»å‡†ç¡®ç‡ï¼Œè¿™æ˜¯ç³»ç»Ÿçš„æœ€ç»ˆæ€§èƒ½æŒ‡æ ‡
- **ğŸ”§ MECæ‰§è¡ŒçŠ¶æ€**ï¼šè¡¨ç¤ºMECæ¡†æ¶æ˜¯å¦æˆåŠŸæ‰§è¡Œå¢å¼ºå¤„ç†
- ç§»é™¤äº†åŸå§‹å‡†ç¡®ç‡å’ŒMECæ¡†æ¶å†…éƒ¨å‡†ç¡®ç‡çš„æ˜¾ç¤ºï¼Œé¿å…æ··æ·†

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```bash
# ç¡®ä¿çŸ¥è¯†åº“å·²æ„å»ºå¹¶åŒ…å«category_image_paths.json
python discovering.py --mode=build_knowledge_base --config_file_expt=./configs/expts/pet37_all.yml

# è¿è¡Œå¢å¼ºåˆ†ç±»ï¼ˆè‡ªåŠ¨ä½¿ç”¨æ–°çš„å›¾åƒè·¯å¾„åŠ è½½æ–¹å¼ï¼‰
python discovering.py --mode=fast_classify_enhanced --config_file_expt=./configs/expts/pet37_all.yml
python discovering.py --mode=slow_classify_enhanced --config_file_expt=./configs/expts/pet37_all.yml
python discovering.py --mode=terminal_decision_enhanced --config_file_expt=./configs/expts/pet37_all.yml
```

## æ€»ç»“

MECæ¡†æ¶æˆåŠŸé›†æˆåˆ°å¿«æ…¢æ€è€ƒç³»ç»Ÿä¸­ï¼Œæä¾›äº†ï¼š
- **æ— ç¼é›†æˆ**ï¼šä½œä¸ºå¯æ’æ‹”å¢å¼ºæ¨¡å—ï¼Œä¸å½±å“åŸæœ‰æµç¨‹
- **æ€§èƒ½æå‡**ï¼šé€šè¿‡å¤šæ¨¡æ€ç‰¹å¾åŒ¹é…æå‡åˆ†ç±»å‡†ç¡®ç‡
- **å¥å£®æ€§**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶
- **å¯æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- **ç­‰ä»·æ€§**ï¼šç¡®ä¿ä¸åŒæ‰§è¡Œè·¯å¾„äº§ç”Ÿä¸€è‡´ç»“æœ
- **ğŸ†• çŸ¥è¯†åº“ä¼˜åŒ–**ï¼šåŸºäºç²¾ç¡®è·¯å¾„çš„å›¾åƒæ£€ç´¢ï¼Œæå‡å‡†ç¡®æ€§å’Œæ•ˆç‡

è¯¥æ¡†æ¶ä¸ºå¤šæ¨¡æ€åˆ†ç±»ä»»åŠ¡æä¾›äº†ä¸€ä¸ªå¼ºå¤§è€Œçµæ´»çš„å¢å¼ºè§£å†³æ–¹æ¡ˆã€‚

---

## ğŸ”§ AWCå¢å¼ºç»“æœæ•´åˆé—®é¢˜åˆ†æä¸ä¿®å¤

### é—®é¢˜å‘ç°

é€šè¿‡åˆ†æflower102æ•°æ®é›†çš„å®éªŒæ—¥å¿—ï¼Œå‘ç°äº†AWCå¢å¼ºç³»ç»Ÿä¸­çš„å‡ ä¸ªå…³é”®é—®é¢˜ï¼š

#### 1. **æ…¢æ€è€ƒå‡†ç¡®ç‡ä¸ä¸€è‡´é—®é¢˜**

**ç°è±¡**ï¼š
- `slow_classify`: 0.4595 (17/37)
- `terminal_decision`: 0.7568 (28/37)
- `slow_classify_enhanced`: 0.6757 (25/37)
- `terminal_decision_enhanced`: 0.2973 (11/37)

**åŸå› åˆ†æ**ï¼š
- `slow_classify` åªè®¡ç®—æ…¢æ€è€ƒæ ·æœ¬æœ¬èº«çš„å‡†ç¡®ç‡
- `terminal_decision` è®¡ç®—çš„æ˜¯"æ…¢æ€è€ƒè§¦å‘ä¸”æœ€ç»ˆæ­£ç¡®"çš„æ ·æœ¬æ•°ï¼ŒåŒ…æ‹¬ç»ˆç«¯å†³ç­–ä¿®æ­£çš„ç»“æœ
- ä¸¤ç§è®¡ç®—æ–¹å¼ä¸ä¸€è‡´ï¼Œå¯¼è‡´æ•°æ®æ··ä¹±

#### 2. **AWCå¢å¼ºæ•ˆæœæ²¡æœ‰ä½“ç°**

**ç°è±¡**ï¼š
- æ…¢æ€è€ƒå¢å¼ºï¼š0.4595 â†’ 0.6757 (æå‡æ˜æ˜¾)
- ä½†æœ€ç»ˆç»“æœï¼š0.8922 â†’ 0.8922 (æ— æå‡)

**åŸå› åˆ†æ**ï¼š
- `terminal_decision_enhanced` ä¸­çš„å¢å¼ºç»“æœæ²¡æœ‰æ­£ç¡®æ•´åˆ
- `is_correct` å­—æ®µæ²¡æœ‰æ ¹æ®å¢å¼ºåçš„é¢„æµ‹ç»“æœæ›´æ–°
- ç»ˆç«¯å†³ç­–é€»è¾‘ä¸åŸç‰ˆä¸ä¸€è‡´

### ä¿®å¤æ–¹æ¡ˆ

#### 1. **ç»Ÿä¸€æ…¢æ€è€ƒå‡†ç¡®ç‡è®¡ç®—é€»è¾‘**

```python
# ä¿®å¤å‰ï¼šå¤æ‚çš„åˆ†ç±»åˆ¤æ–­
for r in slow_results:
    if r.get("decision_path") == "slow_consistent":
        slow_triggered_correct += 1 if r.get("is_correct", False) else 0
    elif r.get("decision_path") == "final_arbitration":
        slow_triggered_correct += 1 if r.get("is_correct", False) else 0

# ä¿®å¤åï¼šç®€åŒ–ç»Ÿä¸€é€»è¾‘
for r in slow_results:
    # æ‰€æœ‰æ…¢æ€è€ƒè§¦å‘çš„æ ·æœ¬ï¼Œåªè¦æœ€ç»ˆæ­£ç¡®å°±è®¡å…¥
    if r.get("is_correct", False):
        slow_triggered_correct += 1
```

#### 2. **ä¿®å¤AWCå¢å¼ºç»“æœæ•´åˆ**

```python
# å…³é”®ä¿®å¤ï¼šæ›´æ–°å¢å¼ºç»“æœä¸­çš„is_correctå­—æ®µ
print(f"ğŸ”„ æ›´æ–°å¢å¼ºç»“æœä¸­çš„is_correctå­—æ®µ...")
for result in fast_results + slow_results:
    true_category = result.get("true_category")
    final_prediction = result.get("final_prediction")
    if true_category and final_prediction:
        result["is_correct"] = is_similar(final_prediction, true_category, threshold=0.5)
print(f"âœ… å·²æ›´æ–°æ‰€æœ‰å¢å¼ºç»“æœçš„is_correctå­—æ®µ")
```

#### 3. **å¢å¼ºé”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯**

```python
# å¢å¼ºé”™è¯¯å¤„ç†
except Exception as e:
    print(f"âŒ åŠ è½½å¢å¼ºç»“æœå¤±è´¥: {e}")
    import traceback
    traceback.print_exc()  # æ‰“å°è¯¦ç»†é”™è¯¯ä¿¡æ¯
    sys.exit(1)
```

### ä¿®å¤æ•ˆæœé¢„æœŸ

ä¿®å¤åï¼Œé¢„æœŸçœ‹åˆ°ä»¥ä¸‹æ”¹è¿›ï¼š

1. **å‡†ç¡®ç‡è®¡ç®—ä¸€è‡´æ€§**ï¼š
   - `slow_classify` å’Œ `terminal_decision` ä¸­çš„æ…¢æ€è€ƒå‡†ç¡®ç‡åº”è¯¥ä¸€è‡´
   - `slow_classify_enhanced` å’Œ `terminal_decision_enhanced` ä¸­çš„æ…¢æ€è€ƒå‡†ç¡®ç‡åº”è¯¥ä¸€è‡´

2. **AWCå¢å¼ºæ•ˆæœä½“ç°**ï¼š
   - å¦‚æœæ…¢æ€è€ƒå¢å¼ºæœ‰æ•ˆæœï¼ˆå¦‚0.4595 â†’ 0.6757ï¼‰ï¼Œæœ€ç»ˆç»“æœä¹Ÿåº”è¯¥æœ‰ç›¸åº”æå‡
   - ç»ˆç«¯å†³ç­–å¢å¼ºåº”è¯¥èƒ½å¤Ÿæ­£ç¡®æ•´åˆå¿«æ…¢æ€è€ƒçš„å¢å¼ºç»“æœ

3. **æ•°æ®ä¸€è‡´æ€§**ï¼š
   - æ‰€æœ‰ç»Ÿè®¡æ•°æ®åº”è¯¥é€»è¾‘ä¸€è‡´
   - å¢å¼ºå‰åçš„å¯¹æ¯”åº”è¯¥æ¸…æ™°å¯è§

### ä½¿ç”¨å»ºè®®

1. **é‡æ–°è¿è¡Œå®éªŒ**ï¼š
   ```bash
   # é‡æ–°è¿è¡Œå¢å¼ºç‰ˆç»ˆç«¯å†³ç­–
   python discovering.py --mode=terminal_decision_enhanced \
     --infer_dir=./experiments/flower102/infer \
     --classify_dir=./experiments/flower102/classify
   ```

2. **éªŒè¯ä¿®å¤æ•ˆæœ**ï¼š
   - æ£€æŸ¥æ…¢æ€è€ƒå‡†ç¡®ç‡æ˜¯å¦ä¸€è‡´
   - éªŒè¯AWCå¢å¼ºæ•ˆæœæ˜¯å¦æ­£ç¡®ä½“ç°åœ¨æœ€ç»ˆç»“æœä¸­
   - ç¡®è®¤æ‰€æœ‰ç»Ÿè®¡æ•°æ®çš„é€»è¾‘ä¸€è‡´æ€§

3. **ç›‘æ§å…³é”®æŒ‡æ ‡**ï¼š
   - æ€»ä½“å‡†ç¡®ç‡æå‡
   - æ…¢æ€è€ƒå‡†ç¡®ç‡æå‡
   - ç»ˆç«¯å†³ç­–æˆåŠŸç‡
   - AWCå¢å¼ºæˆåŠŸç‡

### ä»£ç ä¿®æ”¹ä½ç½®

- **æ–‡ä»¶**ï¼š`/home/hdl/project/fvgr/fgvr_test/discovering.py`
- **ä¿®æ”¹è¡Œå·**ï¼š
  - 1598-1603ï¼šåŸç‰ˆterminal_decisionæ…¢æ€è€ƒå‡†ç¡®ç‡è®¡ç®—
  - 2458-2465ï¼šenhancedç‰ˆæœ¬å¢å¼ºç»“æœis_correctå­—æ®µæ›´æ–°
  - 2639-2644ï¼šenhancedç‰ˆæœ¬æ…¢æ€è€ƒå‡†ç¡®ç‡è®¡ç®—
  - 2466-2470ï¼šå¢å¼ºé”™è¯¯å¤„ç†

é€šè¿‡è¿™äº›ä¿®å¤ï¼ŒAWCå¢å¼ºç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿæ­£ç¡®æ•´åˆå¿«æ…¢æ€è€ƒçš„å¢å¼ºç»“æœï¼Œå¹¶åœ¨æœ€ç»ˆå‡†ç¡®ç‡ä¸­ä½“ç°å‡ºå¢å¼ºæ•ˆæœã€‚

---

## ğŸ”§ AWCç»†åˆ†é€»è¾‘ä¼˜åŒ–

### é—®é¢˜èƒŒæ™¯

é€šè¿‡åˆ†ædog120æ•°æ®é›†çš„å®éªŒç»“æœï¼Œå‘ç°äº†ä¸€ä¸ªå…³é”®é—®é¢˜ï¼š
- **æ…¢æ€è€ƒå‡†ç¡®ç‡æ˜¾è‘—æå‡**ï¼š0.3824 â†’ 0.5784 (æå‡51%)
- **ä½†æ€»ä½“æ•ˆæœåè€Œä¸‹é™**ï¼š0.7667 â†’ 0.7500 (ä¸‹é™2.2%)

è¿™è¯´æ˜AWCå¢å¼ºä¿¡æ¯æ²¡æœ‰è¢«å……åˆ†åˆ©ç”¨ï¼Œéœ€è¦å¯¹AWCæ¡†æ¶è¿›è¡Œç»†åˆ†ä¼˜åŒ–ã€‚

### é…ç½®é©±åŠ¨çš„AWCä¼˜åŒ–ç­–ç•¥

#### 1. **é…ç½®æ–‡ä»¶ç»“æ„**

**æ–‡ä»¶ä½ç½®**ï¼š`/home/hdl/project/fvgr/fgvr_test/Multimodal_Enhanced_Classification/config.yaml`

```yaml
### K-shotæ£€ç´¢å›¾åƒçš„å¤„ç†é€»è¾‘
k_shot_image_processing: "average"  # æˆ– "simultaneously_enhance"

### å›¾-æ–‡ç›¸ä¼¼åº¦è®¡ç®—ç­–ç•¥
similarity_processing: "weighted_separate"  # æˆ– "image_text_pair"

### è¶…å‚æ•°é…ç½®
similarity_processing_hyper_parameter:
  weighted_separate:
    weights: [0.4, 0.4, 0.1, 0.1]  # [æ–‡-æ–‡ï¼Œå›¾-å›¾ï¼Œå›¾-æ–‡ï¼Œæ–‡-å›¾]
  image_text_pair:
    concat_method: "simple"
```

#### 2. **K-shotå›¾åƒå¤„ç†ç­–ç•¥**

##### 2.1 **averageç­–ç•¥ï¼ˆåŸæœ‰ï¼‰**
- **é€»è¾‘**ï¼šå¤šå›¾åƒæœ€ç»ˆåŠ æƒç›¸ä¼¼åº¦ç›´æ¥å–å¹³å‡
- **å®ç°**ï¼šå¯¹kå¼ æ£€ç´¢å›¾åƒåˆ†åˆ«è®¡ç®—ä¸æµ‹è¯•å›¾åƒçš„ç›¸ä¼¼åº¦ï¼Œç„¶åå–å¹³å‡å€¼
- **ä¼˜åŠ¿**ï¼šç®€å•ç›´æ¥ï¼Œè®¡ç®—æ•ˆç‡é«˜
- **åŠ£åŠ¿**ï¼šå¯èƒ½ä¸¢å¤±å›¾åƒé—´çš„å·®å¼‚ä¿¡æ¯

##### 2.2 **simultaneously_enhanceç­–ç•¥ï¼ˆæ–°å¢ï¼‰**
- **é€»è¾‘**ï¼škå¼ å›¾åƒå½¢æˆçš„å­å›¾-æè¿°å¯¹åŒæ—¶ä½œä¸ºå¢å¼ºè§†å›¾
- **å®ç°**ï¼š
  ```python
  # åŸæ¥ï¼škå¼ æ£€ç´¢å›¾åƒï¼Œæ¯å¼ Mä¸ªå­è§†å›¾ â†’ kä¸ªç›¸ä¼¼åº¦å–å¹³å‡
  # ç°åœ¨ï¼škå¼ æ£€ç´¢å›¾åƒï¼Œæ¯å¼ Mä¸ªå­è§†å›¾ â†’ k*(M+1)ä¸ªå¢å¼ºè§†å›¾åŒæ—¶åŠ æƒ
  ```
- **ä¼˜åŠ¿**ï¼šå……åˆ†åˆ©ç”¨æ‰€æœ‰å­è§†å›¾ä¿¡æ¯ï¼Œæå‡ç»†ç²’åº¦åŒ¹é…èƒ½åŠ›
- **é€‚ç”¨åœºæ™¯**ï¼šç»†ç²’åº¦è§†è§‰è¯†åˆ«ï¼Œè§†è§‰ç›¸ä¼¼åº¦é«˜çš„ç±»åˆ«åŒºåˆ†

#### 3. **ç›¸ä¼¼åº¦è®¡ç®—ç­–ç•¥**

##### 3.1 **image_text_pairç­–ç•¥ï¼ˆåŸæœ‰ï¼‰**
- **é€»è¾‘**ï¼šå›¾æ–‡å¯¹æ‹¼æ¥è¿›è¡ŒåŠ æƒ
- **å®ç°**ï¼šå°†å›¾åƒå’Œæ–‡æœ¬ç‰¹å¾æ‹¼æ¥åè®¡ç®—æ•´ä½“ç›¸ä¼¼åº¦
- **å…¬å¼**ï¼š`similarity = cos([I_test, T_test], [I_retrieved, T_retrieved])`

##### 3.2 **weighted_separateç­–ç•¥ï¼ˆæ–°å¢ï¼‰**
- **é€»è¾‘**ï¼šåˆ†å¼€è®¡ç®—å››ç§æ¨¡æ€ç›¸ä¼¼åº¦ï¼Œç„¶ååŠ æƒèåˆ
- **å®ç°**ï¼š
  ```python
  # å››ç§ç›¸ä¼¼åº¦è®¡ç®—
  text_text_sim = cos(T_test, T_retrieved)    # æ–‡-æ–‡
  img_img_sim = cos(I_test, I_retrieved)      # å›¾-å›¾  
  img_text_sim = cos(I_test, T_retrieved)     # å›¾-æ–‡
  text_img_sim = cos(T_test, I_retrieved)     # æ–‡-å›¾
  
  # åŠ æƒèåˆ
  final_sim = w1*text_text_sim + w2*img_img_sim + w3*img_text_sim + w4*text_img_sim
  ```
- **æƒé‡é…ç½®**ï¼š`[0.4, 0.4, 0.1, 0.1]` - åŒæ¨¡æ€æƒé‡é«˜ï¼Œè·¨æ¨¡æ€æƒé‡ä½
- **ä¼˜åŠ¿**ï¼šæ›´ç²¾ç»†çš„å¤šæ¨¡æ€ä¿¡æ¯åˆ©ç”¨ï¼Œèƒ½å¤Ÿæ•è·ä¸åŒæ¨¡æ€é—´çš„å¤æ‚å…³ç³»

#### 4. **æŠ€æœ¯å®ç°ç»†èŠ‚**

##### 4.1 **é…ç½®æ–‡ä»¶è¯»å–**
```python
def load_config(config_path="./config.yaml"):
    """è¯»å–YAMLé…ç½®æ–‡ä»¶"""
    try:
        with open(config_path, 'r', encoding='utf-8') as f:
            config = yaml.safe_load(f)
        return config
    except Exception as e:
        print(f"âš ï¸  è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: {e}")
        return default_config
```

##### 4.2 **weighted_separateç›¸ä¼¼åº¦è®¡ç®—**
```python
@torch.no_grad()
def calculate_weighted_separate_similarity(test_img_feat, test_text_feat, 
                                         retrieved_img_feat, retrieved_text_feat, 
                                         weights=[0.4, 0.4, 0.1, 0.1]):
    """è®¡ç®—weighted_separateç›¸ä¼¼åº¦"""
    # L2å½’ä¸€åŒ–
    test_img_norm = test_img_feat / (test_img_feat.norm() + 1e-8)
    test_text_norm = test_text_feat / (test_text_feat.norm() + 1e-8)
    retrieved_img_norm = retrieved_img_feat / (retrieved_img_feat.norm() + 1e-8)
    retrieved_text_norm = retrieved_text_feat / (retrieved_text_feat.norm() + 1e-8)
    
    # è®¡ç®—å››ç§ç›¸ä¼¼åº¦
    text_text_sim = torch.dot(test_text_norm, retrieved_text_norm)
    img_img_sim = torch.dot(test_img_norm, retrieved_img_norm)
    img_text_sim = torch.dot(test_img_norm, retrieved_text_norm)
    text_img_sim = torch.dot(test_text_norm, retrieved_img_norm)
    
    # åŠ æƒæ±‚å’Œ
    weighted_similarity = (
        weights[0] * text_text_sim +
        weights[1] * img_img_sim +
        weights[2] * img_text_sim +
        weights[3] * text_img_sim
    )
    
    return weighted_similarity
```

##### 4.3 **simultaneously_enhanceå¤„ç†**
```python
@torch.no_grad()
def process_simultaneously_enhance(test_features, retrieved_features_list, config):
    """å®ç°simultaneously_enhanceç­–ç•¥"""
    similarities = []
    
    # å¤„ç†æµ‹è¯•å›¾åƒçš„å¤šè§†å›¾
    if test_features.dim() > 1 and test_features.size(0) > 1:
        test_entropy = calculate_batch_entropy(test_features)
        test_weights = F.softmax(-test_entropy / 0.5, dim=0)
        weighted_test = (test_features * test_weights.unsqueeze(-1)).sum(dim=0)
    else:
        weighted_test = test_features.squeeze(0)
    
    # å¯¹æ¯å¼ æ£€ç´¢å›¾åƒçš„æ¯ä¸ªå­è§†å›¾è®¡ç®—ç›¸ä¼¼åº¦
    for retrieved_features in retrieved_features_list:
        if retrieved_features.dim() > 1 and retrieved_features.size(0) > 1:
            # å¤šè§†å›¾æƒ…å†µï¼šæ¯ä¸ªå­è§†å›¾éƒ½å‚ä¸å¢å¼º
            view_similarities = []
            for view_idx in range(retrieved_features.size(0)):
                single_view = retrieved_features[view_idx]
                view_sim = calculate_similarity(weighted_test, single_view)
                view_similarities.append(view_sim)
            
            # å¯¹æ‰€æœ‰è§†å›¾çš„ç›¸ä¼¼åº¦è¿›è¡Œç†µåŠ æƒå¹³å‡
            if view_similarities:
                view_sims = torch.stack(view_similarities)
                view_entropy = calculate_batch_entropy(view_sims.unsqueeze(-1))
                view_weights = F.softmax(-view_entropy / 0.5, dim=0)
                weighted_similarity = (view_sims * view_weights).sum()
                similarities.append(weighted_similarity)
    
    return torch.stack(similarities).mean() if similarities else torch.tensor(0.0).cuda()
```

#### 5. **ç­–ç•¥ç»„åˆä¸æ•ˆæœé¢„æœŸ**

##### 5.1 **ç­–ç•¥ç»„åˆ**
1. **ä¿å®ˆç»„åˆ**ï¼š`average + image_text_pair` - åŸæœ‰ç­–ç•¥ï¼Œç¨³å®šå¯é 
2. **ç²¾ç»†ç»„åˆ**ï¼š`average + weighted_separate` - æå‡ç›¸ä¼¼åº¦è®¡ç®—ç²¾åº¦
3. **å¢å¼ºç»„åˆ**ï¼š`simultaneously_enhance + image_text_pair` - æå‡k-shotåˆ©ç”¨æ•ˆç‡
4. **æ¿€è¿›ç»„åˆ**ï¼š`simultaneously_enhance + weighted_separate` - æœ€å¤§åŒ–ä¿¡æ¯åˆ©ç”¨

##### 5.2 **æ•ˆæœé¢„æœŸ**
- **weighted_separateç­–ç•¥**ï¼šé¢„æœŸæå‡2-5%å‡†ç¡®ç‡ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤šæ¨¡æ€ä¿¡æ¯ä¸°å¯Œçš„æ•°æ®é›†ä¸Š
- **simultaneously_enhanceç­–ç•¥**ï¼šé¢„æœŸæå‡3-8%å‡†ç¡®ç‡ï¼Œç‰¹åˆ«æ˜¯åœ¨kå€¼è¾ƒå¤§çš„æƒ…å†µä¸‹
- **ç»„åˆç­–ç•¥**ï¼šé¢„æœŸæ€»ä½“æå‡5-12%å‡†ç¡®ç‡ï¼Œè§£å†³æ…¢æ€è€ƒå¢å¼ºæ•ˆæœä¼ é€’å¤±æ•ˆé—®é¢˜

#### 6. **ä½¿ç”¨æ–¹æ³•**

##### 6.1 **ä¿®æ”¹é…ç½®æ–‡ä»¶**
```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim /home/hdl/project/fvgr/fgvr_test/Multimodal_Enhanced_Classification/config.yaml

# é€‰æ‹©ç­–ç•¥ç»„åˆ
k_shot_image_processing: "simultaneously_enhance"
similarity_processing: "weighted_separate"
```

##### 6.2 **è¿è¡Œå®éªŒ**
```bash
# é‡æ–°è¿è¡Œæ…¢æ€è€ƒå¢å¼º
python discovering.py --mode=slow_classify_enhanced \
  --infer_dir=./experiments/dog120/infer \
  --classify_dir=./experiments/dog120/classify

# é‡æ–°è¿è¡Œç»ˆç«¯å†³ç­–å¢å¼º
python discovering.py --mode=terminal_decision_enhanced \
  --infer_dir=./experiments/dog120/infer \
  --classify_dir=./experiments/dog120/classify
```

##### 6.3 **éªŒè¯æ•ˆæœ**
- å¯¹æ¯”ä¸åŒç­–ç•¥ç»„åˆçš„å‡†ç¡®ç‡æå‡
- åˆ†ææ…¢æ€è€ƒå¢å¼ºæ•ˆæœæ˜¯å¦æ­£ç¡®ä¼ é€’åˆ°æœ€ç»ˆç»“æœ
- ç›‘æ§AWCå¢å¼ºä¿¡æ¯çš„åˆ©ç”¨å……åˆ†ç¨‹åº¦

### é¢„æœŸè§£å†³çš„é—®é¢˜

1. **å¢å¼ºæ•ˆæœä¼ é€’å¤±æ•ˆ**ï¼šé€šè¿‡æ›´ç²¾ç»†çš„ç›¸ä¼¼åº¦è®¡ç®—ï¼Œç¡®ä¿AWCå¢å¼ºæ•ˆæœèƒ½å¤Ÿæ­£ç¡®ä¼ é€’
2. **ä¿¡æ¯åˆ©ç”¨ä¸å……åˆ†**ï¼šé€šè¿‡simultaneously_enhanceç­–ç•¥ï¼Œå……åˆ†åˆ©ç”¨kå¼ æ£€ç´¢å›¾åƒçš„æ‰€æœ‰å­è§†å›¾ä¿¡æ¯
3. **å¤šæ¨¡æ€èåˆç²—ç³™**ï¼šé€šè¿‡weighted_separateç­–ç•¥ï¼Œå®ç°æ›´ç²¾ç»†çš„å¤šæ¨¡æ€ä¿¡æ¯èåˆ
4. **æ€»ä½“æ•ˆæœä¸‹é™**ï¼šé€šè¿‡ç­–ç•¥ä¼˜åŒ–ï¼Œç¡®ä¿æ…¢æ€è€ƒå‡†ç¡®ç‡æå‡èƒ½å¤Ÿå¸¦åŠ¨æ€»ä½“å‡†ç¡®ç‡æå‡

è¿™äº›AWCç»†åˆ†é€»è¾‘ä¼˜åŒ–å°†æ˜¾è‘—æå‡å¤šæ¨¡æ€å¢å¼ºåˆ†ç±»çš„æ•ˆæœï¼Œç‰¹åˆ«æ˜¯åœ¨å›°éš¾æ ·æœ¬å’Œç»†ç²’åº¦è¯†åˆ«ä»»åŠ¡ä¸Šã€‚